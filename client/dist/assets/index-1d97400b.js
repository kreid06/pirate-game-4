var ot=Object.defineProperty;var nt=(a,t,e)=>t in a?ot(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var u=(a,t,e)=>(nt(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();class d{constructor(t=0,e=0){this.x=t,this.y=e}static zero(){return new d(0,0)}static from(t,e){return new d(t,e)}clone(){return new d(this.x,this.y)}add(t){return new d(this.x+t.x,this.y+t.y)}sub(t){return new d(this.x-t.x,this.y-t.y)}mul(t){return new d(this.x*t,this.y*t)}div(t){return new d(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}normalize(){const t=this.length();return t===0?d.zero():this.div(t)}perp(){return new d(-this.y,this.x)}rotate(t){const e=Math.cos(t),i=Math.sin(t);return new d(this.x*e-this.y*i,this.x*i+this.y*e)}distanceTo(t){return this.sub(t).length()}lerp(t,e){return this.add(t.sub(this).mul(e))}equals(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e}toString(){return`Vec2(${this.x.toFixed(3)}, ${this.y.toFixed(3)})`}}class st{constructor(t){u(this,"ctx");u(this,"effects",[]);u(this,"quality","medium");u(this,"qualityMultipliers",{low:.5,medium:1,high:2});this.ctx=t}async initialize(){console.log("âœ¨ Particle system initialized")}update(t){const e=t/1e3;for(let i=this.effects.length-1;i>=0;i--){const o=this.effects[i];this.updateEffect(o,e),o.particles.length===0&&this.effects.splice(i,1)}}render(t){this.ctx.save();for(const e of this.effects)this.renderEffect(e,t);this.ctx.restore()}createWaterSplash(t,e=1){const i=Math.floor(20*e*this.qualityMultipliers[this.quality]),o=[];for(let n=0;n<i;n++){const s=n/i*Math.PI*2,r=80+Math.random()*120,l=1.5+Math.random()*1;o.push({position:t.clone(),velocity:d.from(Math.cos(s)*r,Math.sin(s)*r),life:0,maxLife:l,size:2+Math.random()*3,color:"#87ceeb",alpha:.8,gravity:50})}this.effects.push({position:t.clone(),type:"water_splash",intensity:e,particles:o})}createSmokeTrail(t){if(Math.random()>.3)return;const e=[],i=Math.floor(2*this.qualityMultipliers[this.quality]);for(let o=0;o<i;o++){const n=Math.random()*Math.PI*2,s=10+Math.random()*20,r=2+Math.random()*1;e.push({position:t.add(d.from((Math.random()-.5)*5,(Math.random()-.5)*5)),velocity:d.from(Math.cos(n)*s,Math.sin(n)*s),life:0,maxLife:r,size:3+Math.random()*4,color:"#555555",alpha:.6,gravity:-10})}this.effects.push({position:t.clone(),type:"cannonball_smoke",intensity:1,particles:e})}createExplosion(t,e=1){const i=Math.floor(30*e*this.qualityMultipliers[this.quality]),o=[];for(let n=0;n<i;n++){const s=Math.random()*Math.PI*2,r=100+Math.random()*200,l=.5+Math.random()*1;o.push({position:t.clone(),velocity:d.from(Math.cos(s)*r,Math.sin(s)*r),life:0,maxLife:l,size:3+Math.random()*5,color:Math.random()>.5?"#ff6600":"#ffaa00",alpha:1,gravity:0})}this.effects.push({position:t.clone(),type:"explosion",intensity:e,particles:o})}updateQuality(t){this.quality=t,console.log(`âœ¨ Particle quality set to: ${t}`)}shutdown(){this.effects=[],console.log("âœ¨ Particle system shutdown")}updateEffect(t,e){for(let i=t.particles.length-1;i>=0;i--){const o=t.particles[i];if(o.life+=e,o.life>=o.maxLife){t.particles.splice(i,1);continue}this.updateParticle(o,e)}}updateParticle(t,e){t.position=t.position.add(t.velocity.mul(e)),t.velocity=t.velocity.add(d.from(0,t.gravity).mul(e));const i=t.life/t.maxLife;t.alpha=1-i,i>.5&&(t.size*=.95)}renderEffect(t,e){for(const i of t.particles){if(i.alpha<=.1||i.size<=.5||!e.isWorldPositionVisible(i.position,50))continue;const o=e.worldToScreen(i.position),n=e.getState(),s=i.size*n.zoom;s<1||(this.ctx.globalAlpha=i.alpha,this.ctx.fillStyle=i.color,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,s,0,Math.PI*2),this.ctx.fill())}this.ctx.globalAlpha=1}}class at{constructor(t){u(this,"ctx");u(this,"effects",[]);u(this,"nextEffectId",1);this.ctx=t}async initialize(){console.log("ðŸŒŸ Effect renderer initialized")}update(t){const e=t/1e3;for(let i=this.effects.length-1;i>=0;i--){const o=this.effects[i];if(o.age+=e,o.age>=o.maxAge){this.effects.splice(i,1);continue}this.updateEffect(o,e)}}render(t){this.ctx.save();for(const e of this.effects)if(t.isWorldPositionVisible(e.position,100))switch(e.type){case"muzzle_flash":this.renderMuzzleFlash(e,t);break;case"water_wake":this.renderWaterWake(e,t);break;case"explosion_flash":this.renderExplosionFlash(e,t);break}this.ctx.restore()}createMuzzleFlash(t,e,i=1){const o={id:this.nextEffectId++,type:"muzzle_flash",position:t.clone(),direction:e,size:40*i,age:0,maxAge:.15,intensity:i};this.effects.push(o)}createWaterWake(t,e,i){const o={id:this.nextEffectId++,type:"water_wake",position:t.clone(),direction:e,width:i,points:[t.clone()],age:0,maxAge:5,intensity:1};this.effects.push(o)}createExplosionFlash(t,e=1){const i={id:this.nextEffectId++,type:"explosion_flash",position:t.clone(),age:0,maxAge:.3,intensity:e};this.effects.push(i)}shutdown(){this.effects=[],console.log("ðŸŒŸ Effect renderer shutdown")}updateEffect(t,e){switch(t.type){case"water_wake":this.updateWaterWake(t,e);break}}updateWaterWake(t,e){if(t.age%.1<e){const o=t.points[t.points.length-1],n=50,s=o.add(d.from(Math.cos(t.direction)*n*.1,Math.sin(t.direction)*n*.1));t.points.push(s),t.points.length>50&&t.points.shift()}}renderMuzzleFlash(t,e){const i=e.worldToScreen(t.position),o=e.getState(),n=t.size*o.zoom,s=1-t.age/t.maxAge;this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.rotate(t.direction-o.rotation);const r=this.ctx.createRadialGradient(0,0,0,0,0,n);r.addColorStop(0,`rgba(255, 255, 255, ${s})`),r.addColorStop(.5,`rgba(255, 200, 0, ${s*.8})`),r.addColorStop(1,"rgba(255, 100, 0, 0)"),this.ctx.fillStyle=r,this.ctx.fillRect(-n,-n*.3,n*2,n*.6),this.ctx.restore()}renderWaterWake(t,e){if(t.points.length<2)return;const i=e.getState(),o=Math.max(.1,1-t.age/t.maxAge);this.ctx.strokeStyle=`rgba(255, 255, 255, ${o*.3})`,this.ctx.lineWidth=t.width*i.zoom,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath();const n=e.worldToScreen(t.points[0]);this.ctx.moveTo(n.x,n.y);for(let s=1;s<t.points.length;s++){const r=e.worldToScreen(t.points[s]);this.ctx.lineTo(r.x,r.y)}this.ctx.stroke()}renderExplosionFlash(t,e){const i=e.worldToScreen(t.position),o=e.getState(),s=80*t.intensity*o.zoom,r=1-t.age/t.maxAge,l=this.ctx.createRadialGradient(0,0,0,i.x,i.y,s);l.addColorStop(0,`rgba(255, 255, 255, ${r})`),l.addColorStop(.3,`rgba(255, 150, 0, ${r*.8})`),l.addColorStop(.7,`rgba(255, 50, 0, ${r*.4})`),l.addColorStop(1,"rgba(255, 0, 0, 0)"),this.ctx.fillStyle=l,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,Math.PI*2),this.ctx.fill()}}class rt{constructor(t,e){u(this,"canvas");u(this,"ctx");u(this,"config");u(this,"particleSystem");u(this,"effectRenderer");u(this,"renderQueue",[]);u(this,"waterPattern",null);this.canvas=t,this.config=e;const i=t.getContext("2d");if(!i)throw new Error("Failed to get 2D rendering context");this.ctx=i,this.particleSystem=new st(this.ctx),this.effectRenderer=new at(this.ctx)}async initialize(){console.log("ðŸŽ¨ Initializing render system..."),this.setupCanvasProperties(),await this.createWaterPattern(),await this.particleSystem.initialize(),await this.effectRenderer.initialize(),console.log("âœ… Render system initialized")}update(t){this.particleSystem.update(t),this.effectRenderer.update(t)}renderWorld(t,e,i){this.clearCanvas(),this.drawWater(e),this.drawGrid(e),this.queueWorldObjects(t,e,i),this.executeRenderQueue(),this.particleSystem.render(e),this.effectRenderer.render(e)}renderLoadingScreen(t,e){this.clearCanvas(),this.ctx.fillStyle="#1e90ff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.font="48px Arial",this.ctx.textAlign="center";let i="Loading...";switch(t){case _.INITIALIZING:i="Initializing Game...";break;case _.CONNECTING:i="Connecting to Server...";break;case _.CONNECTED:i="Entering World...";break;case _.DISCONNECTED:i="Disconnected - Reconnecting...";break;case _.ERROR:i="Connection Error",this.ctx.fillStyle="#ff4444";break}this.ctx.fillText(i,this.canvas.width/2,this.canvas.height/2),t!==_.ERROR&&this.drawLoadingSpinner()}getContext(){return this.ctx}onCanvasResize(t,e){this.createWaterPattern()}updateConfig(t){this.config={...t},this.setupCanvasProperties(),this.particleSystem.updateQuality(t.particleQuality)}shutdown(){this.particleSystem.shutdown(),this.effectRenderer.shutdown()}setupCanvasProperties(){this.config.antialiasing?(this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high"):this.ctx.imageSmoothingEnabled=!1}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}async createWaterPattern(){const t=document.createElement("canvas");t.width=64,t.height=64;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,64,64);i.addColorStop(0,"#1e90ff"),i.addColorStop(.5,"#4169e1"),i.addColorStop(1,"#1e90ff"),e.fillStyle=i,e.fillRect(0,0,64,64),e.globalCompositeOperation="overlay",e.fillStyle="#ffffff10";for(let o=0;o<10;o++)e.beginPath(),e.arc(Math.random()*64,Math.random()*64,Math.random()*5+2,0,Math.PI*2),e.fill();this.waterPattern=this.ctx.createPattern(t,"repeat")}drawWater(t){this.waterPattern?this.ctx.fillStyle=this.waterPattern:this.ctx.fillStyle="#1e90ff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawGrid(t){t.getState();const e=t.getWorldBounds();this.ctx.strokeStyle="#ffffff20",this.ctx.lineWidth=1;const i=100,o=Math.floor(e.min.x/i)*i,n=Math.ceil(e.max.x/i)*i,s=Math.floor(e.min.y/i)*i,r=Math.ceil(e.max.y/i)*i;for(let l=o;l<=n;l+=i){const c=t.worldToScreen(d.from(l,e.min.y)),h=t.worldToScreen(d.from(l,e.max.y));this.ctx.beginPath(),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(h.x,h.y),this.ctx.stroke()}for(let l=s;l<=r;l+=i){const c=t.worldToScreen(d.from(e.min.x,l)),h=t.worldToScreen(d.from(e.max.x,l));this.ctx.beginPath(),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(h.x,h.y),this.ctx.stroke()}}queueWorldObjects(t,e,i){this.renderQueue=[];for(const o of t.ships)this.queueRenderItem(1,"ships",()=>this.drawShip(o,e));for(const o of t.players)this.queueRenderItem(2,"players",()=>this.drawPlayer(o,e));for(const o of t.cannonballs)this.queueRenderItem(3,"cannonballs",()=>this.drawCannonball(o,e))}queueRenderItem(t,e,i,o=0){this.renderQueue.push({layer:t,layerName:e,renderFn:i,priority:o})}executeRenderQueue(){this.renderQueue.sort((t,e)=>t.layer!==e.layer?t.layer-e.layer:(t.priority||0)-(e.priority||0));for(const t of this.renderQueue)try{t.renderFn()}catch(e){console.error(`Error rendering ${t.layerName}:`,e)}}drawShip(t,e){if(!e.isWorldPositionVisible(t.position,200))return;this.ctx.save();const i=e.worldToScreen(t.position),o=e.getState();this.ctx.translate(i.x,i.y),this.ctx.scale(o.zoom,o.zoom),this.ctx.rotate(t.rotation-o.rotation),this.drawShipHull(t),this.ctx.strokeStyle="#ff0000",this.ctx.lineWidth=4/o.zoom,this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(80,0),this.ctx.stroke(),this.ctx.restore()}drawShipHull(t){if(t.hull.length!==0){this.ctx.strokeStyle="#8B4513",this.ctx.fillStyle="#DEB887",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(t.hull[0].x,t.hull[0].y);for(let e=1;e<t.hull.length;e++)this.ctx.lineTo(t.hull[e].x,t.hull[e].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}}drawPlayer(t,e){if(!e.isWorldPositionVisible(t.position,50))return;const i=e.worldToScreen(t.position),o=e.getState(),n=t.radius*o.zoom;this.ctx.fillStyle=t.onDeck?"#00ff00":"#ff0000",this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,n,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="#ffff00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y);const s=e.worldToScreen(t.position.add(t.velocity.mul(.1)));this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}drawCannonball(t,e){if(!e.isWorldPositionVisible(t.position,20))return;const i=e.worldToScreen(t.position),o=e.getState(),n=t.radius*o.zoom;this.ctx.fillStyle="#333333",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,n,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke()}drawLoadingSpinner(){const t=this.canvas.width/2,e=this.canvas.height/2+100,i=30,o=Date.now()/100;this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.arc(t,e,i,o,o+Math.PI*1.5),this.ctx.stroke()}}class ct{constructor(t,e){u(this,"viewport");u(this,"state");u(this,"targetPosition",null);u(this,"velocity",d.zero());this.viewport=t,this.state={position:e.position.clone(),zoom:e.zoom,rotation:e.rotation}}getState(){return{position:this.state.position.clone(),zoom:this.state.zoom,rotation:this.state.rotation}}setPosition(t){this.state.position=t.clone(),this.targetPosition=null}setZoom(t){this.state.zoom=Math.max(.1,Math.min(10,t))}setRotation(t){this.state.rotation=t}setTarget(t){this.targetPosition=t.clone()}followTarget(t,e,i){if(!t)return;const o=t.sub(this.state.position);if(o.lengthSq()<.1){this.state.position=t.clone(),this.velocity=d.zero();return}const n=e,s=2*Math.sqrt(n),r=o.mul(n).sub(this.velocity.mul(s));this.velocity=this.velocity.add(r.mul(i)),this.state.position=this.state.position.add(this.velocity.mul(i))}zoomBy(t,e){const i=this.screenToWorld(e),o=this.state.zoom*t;this.setZoom(o);const n=this.worldToScreen(i),s=e.sub(n),r=this.screenToWorldDelta(s);this.state.position=this.state.position.sub(r)}worldToScreen(t){const i=t.sub(this.state.position).mul(this.state.zoom),o=Math.cos(-this.state.rotation),n=Math.sin(-this.state.rotation);return d.from(i.x*o-i.y*n,i.x*n+i.y*o).add(d.from(this.viewport.width/2,this.viewport.height/2))}screenToWorld(t){const e=t.sub(d.from(this.viewport.width/2,this.viewport.height/2)),i=Math.cos(this.state.rotation),o=Math.sin(this.state.rotation);return d.from(e.x*i-e.y*o,e.x*o+e.y*i).mul(1/this.state.zoom).add(this.state.position)}screenToWorldDelta(t){const e=Math.cos(this.state.rotation),i=Math.sin(this.state.rotation);return d.from(t.x*e-t.y*i,t.x*i+t.y*e).mul(1/this.state.zoom)}getWorldBounds(){const t=this.screenToWorld(d.zero()),e=this.screenToWorld(d.from(this.viewport.width,0)),i=this.screenToWorld(d.from(0,this.viewport.height)),o=this.screenToWorld(d.from(this.viewport.width,this.viewport.height)),n=[t,e,i,o];let s=n[0].x,r=n[0].y,l=n[0].x,c=n[0].y;for(const h of n)s=Math.min(s,h.x),r=Math.min(r,h.y),l=Math.max(l,h.x),c=Math.max(c,h.y);return{min:d.from(s,r),max:d.from(l,c)}}isWorldPositionVisible(t,e=0){const i=this.getWorldBounds();return t.x>=i.min.x-e&&t.x<=i.max.x+e&&t.y>=i.min.y-e&&t.y<=i.max.y+e}setViewport(t){this.viewport={...t}}getViewport(){return{...this.viewport}}}var W=(a=>(a.DISCONNECTED="disconnected",a.CONNECTING="connecting",a.CONNECTED="connected",a.RECONNECTING="reconnecting",a.ERROR="error",a))(W||{});class lt{constructor(t){u(this,"config");u(this,"socket",null);u(this,"connectionState","disconnected");u(this,"reconnectAttempts",0);u(this,"reconnectTimer",null);u(this,"pingTimer",null);u(this,"assignedPlayerId",null);u(this,"messageSequenceId",0);u(this,"pendingPings",new Map);u(this,"playerName","Player_"+Math.random().toString(36).substr(2,5));u(this,"stats",{ping:0,packetLoss:0,bytesReceived:0,bytesSent:0,messagesReceived:0,messagesSent:0,averageFPS:30});u(this,"latency",0);u(this,"onWorldStateReceived",null);u(this,"onConnectionStateChanged",null);this.config=t;const e=Math.random().toString(36).substr(2,9);console.log(`ðŸ“¡ [${e}] NetworkManager instance created`)}setWorldStateHandler(t){this.onWorldStateReceived=t}setConnectionStateHandler(t){this.onConnectionStateChanged=t}getStats(){return{ping:this.latency,packetLoss:0,bytesReceived:this.stats.bytesReceived,bytesSent:this.stats.bytesSent,messagesReceived:this.stats.messagesReceived,messagesSent:this.stats.messagesSent,averageFPS:0}}async connect(t){var i;if(t&&(this.playerName=t),this.socket&&(console.log("ðŸ”Œ Closing existing socket before reconnection"),this.socket.close(),this.socket=null),this.connectionState==="connecting"||this.connectionState==="connected"){console.log("âš ï¸ Already connecting/connected, skipping duplicate connection attempt");return}this.connectionState="connecting";const e=Math.random().toString(36).substr(2,9);console.log(`ðŸŒ [${e}] Connecting to server: ${this.config.serverUrl}`);try{console.log(`ðŸ”Œ [${e}] Creating new WebSocket connection`),console.log(`ðŸ”Œ [${e}] URL: ${this.config.serverUrl}`),console.log(`ðŸ”Œ [${e}] Current socket state: ${this.socket?"exists":"null"}`),this.socket=new WebSocket(this.config.serverUrl),this.setupSocketHandlers(),await this.waitForConnection(),await this.sendHandshake(),this.startHeartbeat(),this.connectionState="connected",this.reconnectAttempts=0,console.log("âœ… Connected to server"),(i=this.onConnectionStateChanged)==null||i.call(this,"connected")}catch(o){throw this.connectionState="error",console.error("âŒ Failed to connect to server:",o),this.scheduleReconnect(),o}}disconnect(){var t;console.log("ðŸ”Œ Disconnecting from server..."),this.connectionState="disconnected",this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.pingTimer&&(clearInterval(this.pingTimer),this.pingTimer=null),this.socket&&(this.socket.close(),this.socket=null),(t=this.onConnectionStateChanged)==null||t.call(this,"disconnected"),console.log("âœ… Disconnected from server")}async sendHandshake(){return new Promise((t,e)=>{if(!this.socket){e(new Error("No socket available"));return}const i={type:"handshake",playerName:this.playerName,protocolVersion:"1.0",timestamp:Date.now()},o=JSON.stringify(i),n=setTimeout(()=>{console.warn("âš ï¸ Handshake timeout - server may not be responding"),t()},5e3),s=this.socket.onmessage;this.socket.onmessage=r=>{try{const l=r.data;console.log("ðŸ“¨ Handshake response received:",l);let c={};try{c=JSON.parse(l)}catch{c={type:"text",message:l}}c.type==="handshake_response"&&c.player_id?(this.assignedPlayerId=c.player_id,console.log(`ðŸŽ® Server assigned player ID: ${this.assignedPlayerId}`),clearTimeout(n),this.socket.onmessage=s,console.log("ðŸ¤ Handshake completed - Player ID received"),this.requestGameState(),t()):l.includes("message_ack")||l.includes("status")||l.startsWith("PONG")?(clearTimeout(n),this.socket.onmessage=s,console.log("ðŸ¤ Handshake completed - Server acknowledged"),this.requestGameState(),t()):(clearTimeout(n),this.socket.onmessage=s,console.log("ðŸ¤ Handshake completed (server responded)"),this.requestGameState(),t())}catch(l){console.warn("Error during handshake:",l),clearTimeout(n),this.socket.onmessage=s,console.log("ðŸ¤ Handshake completed (server alive)"),this.requestGameState(),t()}};try{this.socket.send(o),this.stats.messagesSent++,this.stats.bytesSent+=o.length,console.log("ðŸ“¤ Sent handshake:",o)}catch(r){clearTimeout(n),console.error("âŒ Failed to send handshake:",r),e(r)}})}requestGameState(){this.socket&&this.socket.readyState===WebSocket.OPEN&&(this.socket.send("STATE"),this.stats.messagesSent++,this.stats.bytesSent+=5,console.log("ðŸ“¤ Requested game state from server"))}sendInput(t){if(this.connectionState!=="connected"||!this.socket){console.log(`ðŸš« Cannot send input - Connection state: ${this.connectionState}, Socket: ${this.socket?"exists":"null"}`);return}const e=t.movement.lengthSq()>0,i=t.actions!==0,o=!0;{console.log(`ðŸ” Input frame check - Movement: ${e}, Actions: ${i}, Sending: ${o}`);const n=Math.sqrt(t.movement.lengthSq());n>1.1&&(console.warn(`âš ï¸ Movement vector too large: ${n.toFixed(3)}, normalizing...`),t.movement=t.movement.normalize());const s={type:"input",timestamp:Date.now(),sequenceId:this.messageSequenceId++,tick:t.tick,movement_x:t.movement.x,movement_y:t.movement.y,flags:t.actions};console.log(`ðŸŽ® Sending input - Movement: (${t.movement.x.toFixed(2)}, ${t.movement.y.toFixed(2)}), Magnitude: ${n.toFixed(2)}, Actions: ${t.actions}`),this.sendMessage(s)}}getNetworkStats(){return{...this.stats}}getConnectionState(){return this.connectionState}getAssignedPlayerId(){return this.assignedPlayerId}setupSocketHandlers(){this.socket&&(this.socket.onopen=t=>{console.log("ðŸ”— WebSocket opened")},this.socket.onmessage=t=>{try{const e=t.data;let i;if(e.startsWith("{"))try{i=JSON.parse(e)}catch{console.warn("Failed to parse JSON message:",e);return}else if(e==="PONG")i={type:"pong",timestamp:Date.now(),sequenceId:this.messageSequenceId-1};else if(e.startsWith("WELCOME"))i={type:"welcome",message:e,timestamp:Date.now()};else if(e.startsWith("GAME_STATE:"))try{const o=e.substring(11);i={type:"GAME_STATE",...JSON.parse(o),timestamp:Date.now()}}catch{console.warn("Failed to parse GAME_STATE:",e);return}else console.log("ðŸ“¦ Server text message:",e),i={type:"text",message:e,timestamp:Date.now()};this.handleMessage(i),this.stats.messagesReceived++,this.stats.bytesReceived+=e.length}catch(e){console.error("Failed to process message:",e,"Data:",t.data),this.stats.messagesReceived++,this.stats.bytesReceived+=t.data.length}},this.socket.onclose=t=>{var e;console.log("ðŸ”Œ WebSocket closed:",t.code,t.reason),this.connectionState==="connected"&&(this.connectionState="disconnected",(e=this.onConnectionStateChanged)==null||e.call(this,"disconnected"),this.scheduleReconnect())},this.socket.onerror=t=>{console.error("âŒ WebSocket error:",t),this.connectionState="error"})}async waitForConnection(){return new Promise((t,e)=>{if(!this.socket){e(new Error("No socket created"));return}const i=setTimeout(()=>{e(new Error("Connection timeout"))},this.config.timeoutDuration);this.socket.onopen=()=>{clearTimeout(i),t()},this.socket.onerror=()=>{clearTimeout(i),e(new Error("Connection failed"))}})}handleMessage(t){var e,i;switch(t.type){case"world_state":case"snapshot":t.worldState&&((e=this.onWorldStateReceived)==null||e.call(this,t.worldState));break;case"GAME_STATE":const o={tick:t.tick||0,timestamp:Date.now(),ships:(t.ships||[]).map(n=>({id:n.id||0,position:n.position?d.from(n.position.x||0,n.position.y||0):d.zero(),velocity:n.velocity?d.from(n.velocity.x||0,n.velocity.y||0):d.zero(),rotation:n.rotation||0,angularVelocity:n.angularVelocity||0,hull:(n.hull||[]).map(s=>s?d.from(s.x||0,s.y||0):d.zero()),modules:n.modules||[]})),players:(t.players||[]).map(n=>({id:n.id||0,position:n.position?d.from(n.position.x||0,n.position.y||0):d.from(n.x||0,n.y||0),velocity:n.velocity?d.from(n.velocity.x||0,n.velocity.y||0):d.from(n.velocity_x||0,n.velocity_y||0),radius:n.radius||8,carrierId:n.carrierId||0,deckId:n.deckId||0,onDeck:n.onDeck||!1})),cannonballs:(t.projectiles||[]).map(n=>({id:n.id||0,position:n.position?d.from(n.position.x||0,n.position.y||0):d.zero(),velocity:n.velocity?d.from(n.velocity.x||0,n.velocity.y||0):d.zero(),firingVelocity:n.firingVelocity?d.from(n.firingVelocity.x||0,n.firingVelocity.y||0):d.zero(),smokeTrail:(n.smokeTrail||[]).map(s=>({position:s.position?d.from(s.position.x||0,s.position.y||0):d.zero(),age:s.age||0}))})),carrierDetection:new Map};if(console.log(`ðŸ—ºï¸ Received game state - Tick: ${o.tick}, Players: ${o.players.length}, Ships: ${o.ships.length}`),o.players.length>0){const n=o.players[0];console.log(`ðŸŽ® Player ${n.id} position: (${n.position.x.toFixed(1)}, ${n.position.y.toFixed(1)})`)}(i=this.onWorldStateReceived)==null||i.call(this,o);break;case"pong":this.handlePong(t);break;case"handshake_response":console.log("ðŸ¤ Received handshake response:",t),t.player_id!==void 0&&(this.assignedPlayerId=t.player_id,console.log(`ðŸŽ® Server assigned player ID: ${this.assignedPlayerId}`));break;case"message_ack":console.log("âœ… Server acknowledged message:",t.status);break;default:console.log("ðŸ“¦ Received message:",t.type,t);break}}handlePong(t){if(!t.sequenceId)return;const e=this.pendingPings.get(t.sequenceId);if(e){const i=Date.now()-e;this.stats.ping=i,this.pendingPings.delete(t.sequenceId)}}sendMessage(t){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const e=JSON.stringify(t);this.socket.send(e),this.stats.messagesSent++,this.stats.bytesSent+=e.length}catch(e){console.error("Failed to send message:",e)}}startHeartbeat(){this.pingTimer=setInterval(()=>{this.sendPing(),Math.random()<.3&&this.requestGameState()},this.config.heartbeatInterval)}sendPing(){const t=this.messageSequenceId++,e=Date.now();if(this.socket&&this.socket.readyState===WebSocket.OPEN){this.socket.send("PING"),this.pendingPings.set(t,e),this.stats.messagesSent++,this.stats.bytesSent+=4;const i=e-1e4;for(const[o,n]of this.pendingPings.entries())n<i&&this.pendingPings.delete(o)}}scheduleReconnect(){if(this.reconnectAttempts>=this.config.maxReconnectAttempts){console.error("âŒ Max reconnection attempts reached"),this.connectionState="error";return}this.reconnectAttempts++;const t=this.config.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`ðŸ”„ Scheduling reconnect attempt ${this.reconnectAttempts} in ${t}ms`),this.connectionState="reconnecting",this.reconnectTimer=setTimeout(()=>{this.connect().catch(e=>{console.error("Reconnection failed:",e)})},t)}}class O{static wrap(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}static diff(t,e){return O.wrap(t-e)}static lerp(t,e,i){const o=O.diff(e,t);return O.wrap(t+o*i)}static toRadians(t){return t*Math.PI/180}static toDegrees(t){return t*180/Math.PI}}class D{static pointInPolygon(t,e,i=0){if(e.length<3)return!1;let o=!1;const n=e.length;for(let s=0,r=n-1;s<n;r=s++){const l=e[s],c=e[r];if(l.y>t.y!=c.y>t.y){const h=(c.x-l.x)*(t.y-l.y)/(c.y-l.y)+l.x;t.x<h&&(o=!o)}}if(!o&&i>0)for(let s=0;s<n;s++){const r=(s+1)%n;if(D.pointToSegmentDistance(t,e[s],e[r])<=i)return!0}return o}static pointToSegmentDistance(t,e,i){const o=i.sub(e),n=o.length();if(n===0)return t.distanceTo(e);const s=Math.max(0,Math.min(1,t.sub(e).dot(o)/n)),r=e.add(o.mul(s));return t.distanceTo(r)}static closestPointOnPolygon(t,e){if(e.length===0)return t.clone();if(e.length===1)return e[0].clone();let i=e[0].clone(),o=t.distanceTo(e[0]);for(let n=0;n<e.length;n++){const s=(n+1)%e.length,r=e[n],c=e[s].sub(r),h=c.lengthSq();if(h===0){const y=t.distanceTo(r);y<o&&(o=y,i=r.clone());continue}const f=Math.max(0,Math.min(1,t.sub(r).dot(c)/h)),m=r.add(c.mul(f)),g=t.distanceTo(m);g<o&&(o=g,i=m)}return i}static sweptCircleVsSegment(t,e,i,o,n){const s={hit:!1,time:1,point:d.zero(),normal:d.zero()},r=e.sub(t),l=n.sub(o),c=l.perp().normalize();if(r.dot(c)>=0)return s;const h=t.sub(o).dot(c),f=e.sub(o).dot(c);if(Math.abs(h)<=i||Math.abs(f)<=i){const m=(Math.abs(h)-i)/Math.abs(r.dot(c));if(m>=0&&m<=1){const g=t.add(r.mul(m)),y=l.lengthSq();if(y>0){const p=g.sub(o).dot(l)/y;p>=0&&p<=1&&(s.hit=!0,s.time=m,s.point=o.add(l.mul(p)),s.normal=c.mul(h<0?-1:1))}}}return s}static slideAlongPolygon(t,e,i,o,n){let s=t.clone(),r=e.clone();const l=t.add(e.mul(n));for(let c=0;c<3;c++){let h=null,f=1;for(let p=0;p<o.length;p++){const x=(p+1)%o.length,v=D.sweptCircleVsSegment(s,l,i,o[p],o[x]);v.hit&&v.time<f&&(f=v.time,h=v)}if(!h){s=l;break}const m=l.sub(s);s=s.add(m.mul(h.time));const g=m.mul(1-h.time),y=g.sub(h.normal.mul(g.dot(h.normal)));if(r=y.div(n),y.lengthSq()<.001)break}return{newPosition:s,newVelocity:r}}static distanceToPolygonEdge(t,e){if(e.length<3)return 0;let i=1/0,o=!1;for(let n=0,s=e.length-1;n<e.length;s=n++){const r=e[n],l=e[s];r.y>t.y!=l.y>t.y&&t.x<(l.x-r.x)*(t.y-r.y)/(l.y-r.y)+r.x&&(o=!o)}for(let n=0;n<e.length;n++){const s=(n+1)%e.length,r=e[n],c=e[s].sub(r),h=c.lengthSq();if(h===0){const y=t.distanceTo(r);i=Math.min(i,y);continue}const f=Math.max(0,Math.min(1,t.sub(r).dot(c)/h)),m=r.add(c.mul(f)),g=t.distanceTo(m);i=Math.min(i,g)}return o?i:-i}}const R={SIM_TICK_RATE:60,SNAPSHOT_RATE:15,INTERP_BUFFER_MS:120,EPS_FACTOR:.03,N_IN:3,N_OUT:8,SWITCH_COOLDOWN_MS:200,HISTORY_TICKS:20,ICE_DRIFT_HALF_LIFE:.35,PLAYER_SPEED:200,PLAYER_RADIUS:8,CANNONBALL_SPEED:400,CANNONBALL_RANGE:800,CANNONBALL_RADIUS:8,CANNONBALL_RELOAD_TIME:3,SPLASH_RADIUS:50},A=[],$=class ${static trackCollision(t,e,i,o,n,s=!0,r){A.push({timestamp:Date.now(),playerPosition:t,collisionPoint:e,normal:i,penetrationDepth:o,slideDistance:n,isPlankCollision:s,plankId:r});const l=Date.now()-5e3;for(;A.length>0&&A[0].timestamp<l;)A.shift();A.length>100&&A.splice(0,50)}static getRecentCollisions(){return[...A]}static clearCollisionTracking(){A.length=0}static sweptCircleVsPolygon(t){const{startPos:e,endPos:i,radius:o,velocity:n,polygon:s,epsilon:r}=t,l=o+r,c=D.pointInPolygon(e,s,l),h=D.pointInPolygon(i,s,l);return c&&h?{newPosition:i,newVelocity:n,collided:!1,normal:d.zero(),penetrationDepth:0,contactPoint:i,slideDistance:0}:c&&!h?this.handleExitCollision(t):!c&&!h?this.handleEntryOrSlide(t):this.handleEntry(t)}static handleExitCollision(t){const{startPos:e,endPos:i,radius:o,velocity:n,polygon:s,epsilon:r}=t,l=o+r,c=i.sub(e);let h=null,f=1/0;for(let y=0;y<s.length;y++){const p=s[y],x=s[(y+1)%s.length],v=this.rayVsLineSegment(e,c,p,x,l);v&&v.t<f&&v.t>=0&&v.t<=1&&(f=v.t,h={edge:[p,x],t:v.t,normal:v.normal})}if(!h)return this.clampToClosestPoint(t);const m=e.add(c.mul(h.t)),g=this.calculateSlideVelocity(n,h.normal);return{newPosition:m,newVelocity:g,collided:!0,normal:h.normal,penetrationDepth:0,contactPoint:m,slideDistance:g.length()*t.dt}}static handleEntryOrSlide(t){return this.sweptCirclePolygon(t)}static sweptCirclePolygon(t){const{startPos:e,endPos:i,radius:o,polygon:n,epsilon:s,velocity:r}=t,l=o+s,c=i.sub(e),h=c.length();if(h<1e-6)return this.clampToClosestPoint(t);const f=c.normalize();let m=1/0,g=d.zero(),y=e;for(let p=0;p<n.length;p++){const x=n[p],S=n[(p+1)%n.length].sub(x),k=S.length();if(k<1e-6)continue;const P=S.normalize(),w=d.from(-P.y,P.x),b=-f.dot(w);if(b<=0)continue;const I=(e.sub(x).dot(w)-l)/b;if(I<0||I>h/r.length())continue;const T=e.add(f.mul(I*r.length())),z=T.sub(x).dot(P);z>=0&&z<=k&&I<m&&(m=I,g=w,y=T)}for(const p of n){const x=e.sub(p),v=c.dot(c),S=2*x.dot(c),k=x.dot(x)-l*l,P=S*S-4*v*k;if(P>=0){const w=(-S-Math.sqrt(P))/(2*v),b=(-S+Math.sqrt(P))/(2*v),C=w>=0&&w<=1?w:b>=0&&b<=1?b:-1;if(C>=0&&C<m/h){const M=e.add(c.mul(C)),I=M.sub(p).normalize();m=C*h,g=I,y=M}}}if(m<1/0){const p=f.sub(g.mul(f.dot(g))),x=h-m,v=p.mul(r.length());return{newPosition:y.add(p.mul(x)),newVelocity:v,collided:!0,normal:g,penetrationDepth:0,contactPoint:y,slideDistance:x}}return{newPosition:i,newVelocity:r,collided:!1,normal:d.zero(),penetrationDepth:0,contactPoint:i,slideDistance:0}}static handleEntry(t){return{newPosition:t.endPos,newVelocity:t.velocity,collided:!1,normal:d.zero(),penetrationDepth:0,contactPoint:t.endPos,slideDistance:0}}static clampToClosestPoint(t){const{endPos:e,radius:i,polygon:o,epsilon:n}=t,s=i+n,r=D.closestPointOnPolygon(e,o),l=e.sub(r),c=l.length();if(c<s){const h=c>0?l.normalize():d.from(0,-1);return{newPosition:r.add(h.mul(s)),newVelocity:d.zero(),collided:!0,normal:h,penetrationDepth:s-c,contactPoint:r,slideDistance:0}}return{newPosition:e,newVelocity:t.velocity,collided:!1,normal:d.zero(),penetrationDepth:0,contactPoint:e,slideDistance:0}}static rayVsLineSegment(t,e,i,o,n){const s=o.sub(i),r=s.length();if(r<1e-10)return null;const c=s.normalize().perp(),f=i.add(c.mul(n)).sub(t),m=e.length();if(m<1e-10)return null;const g=e.normalize(),y=g.x*s.y-g.y*s.x;if(Math.abs(y)<1e-10)return null;const p=(f.x*s.y-f.y*s.x)/y,x=(f.x*g.y-f.y*g.x)/y;return x>=0&&x<=r&&p>=0?{t:p/m,normal:c.mul(-1)}:null}static calculateSlideVelocity(t,e){const i=t.dot(e);return i>=0?t:t.sub(e.mul(i))}static resolvePenetration(t,e,i,o){const n=e.length()+o;if(D.pointInPolygon(t,i,n)){const s=D.closestPointOnPolygon(t,i),r=t.sub(s),l=r.length(),c=n-l;if(c>0){const h=l>0?r.normalize():d.from(0,-1);return{newPosition:s.add(h.mul(n)),penetrationDepth:c,normal:h}}}return{newPosition:t,penetrationDepth:0,normal:d.zero()}}static createPlankCollisionSegments(t){const e=[],i=t.modules.filter(o=>o.kind!=="plank"||!o.moduleData||o.moduleData.kind!=="plank"?!1:o.moduleData.health>0);for(const o of i)if(o.moduleData&&o.moduleData.kind==="plank"){const n=o.moduleData,s=o.localPos,r=o.localRot,l=n.length/2,c=n.width/2,m=[d.from(-l,-c),d.from(l,-c),d.from(l,c),d.from(-l,c)].map(g=>g.rotate(r).add(s)).map(g=>g.rotate(t.rotation).add(t.position));for(let g=0;g<m.length;g++){const y=m[g],p=m[(g+1)%m.length];e.push({start:y,end:p,plankId:o.id})}}return e}static sweptCircleVsPlankSegments(t,e,i,o,n,s,r,l=!0,c=!1){const h=this.createPlankCollisionSegments(n),f=[];if(l){const S=n.modules.filter(k=>k.kind==="ladder");for(const k of S)if(k.moduleData&&k.moduleData.kind==="ladder"){const P=k.moduleData,w=k.localPos,b=P.length,C=P.width,M=P.extendDirection||Math.PI,I=d.from(Math.cos(M),Math.sin(M)),T=I.perp(),E=C/2,z=w.add(I.mul(b)),H=[w.add(T.mul(E)),w.add(T.mul(-E)),z.add(T.mul(-E)),z.add(T.mul(E))].map(it=>it.rotate(n.rotation).add(n.position));f.push(H)}}const m=f.some(S=>D.pointInPolygon(t,S,i+s)||D.pointInPolygon(e,S,i+s)),g=this.isPlayerInsideShipBounds(t,n,i+s),y=this.isPlayerInsideShipBounds(e,n,i+s);if(g&&!y&&!c&&!m){const S=this.clampPlayerToShipBounds(e,n,i+s),k=S.sub(t),P=k.length()>0?k.normalize().mul(o.length()):d.zero(),w=S.sub(e),b=w.length()>0?w.normalize():d.from(0,-1);return $.trackCollision(t,S,b,e.sub(S).length(),k.length(),!0,-1),{newPosition:S,newVelocity:P,collided:!0,normal:b,penetrationDepth:e.sub(S).length(),contactPoint:S,slideDistance:k.length()}}if(c)return{newPosition:e,newVelocity:o,collided:!1,normal:d.zero(),penetrationDepth:0,contactPoint:d.zero(),slideDistance:0};if(m&&!g&&y&&l)return{newPosition:e,newVelocity:o,collided:!1,normal:d.zero(),penetrationDepth:0,contactPoint:d.zero(),slideDistance:0};let p=null,x=1/0,v;for(const S of h){const k=S.start,P=S.end,w=D.sweptCircleVsSegment(t,e,i,k,P);if(w.hit&&w.time<x){x=w.time,v=S.plankId;const b=t.add(e.sub(t).mul(w.time)),C=o.dot(w.normal),M=o.sub(w.normal.mul(C*2));p={newPosition:b,newVelocity:M,collided:!0,normal:w.normal,penetrationDepth:0,contactPoint:w.point,slideDistance:0}}}return p?($.trackCollision(t,p.contactPoint,p.normal,p.penetrationDepth,p.slideDistance,!0,v),p):{newPosition:e,newVelocity:o,collided:!1,normal:d.zero(),penetrationDepth:0,contactPoint:d.zero(),slideDistance:0}}static isPlayerInsideShipBounds(t,e,i){const o=this.getTransformedShipHull(e);return D.pointInPolygon(t,o,i)}static getTransformedShipHull(t){const e=t.id.toString(),i=this.hullCache.get(e);if(i&&i.position.equals(t.position)&&Math.abs(i.rotation-t.rotation)<1e-6)return i.hull;const o=t.hull.map(n=>n.rotate(t.rotation).add(t.position));return this.hullCache.set(e,{hull:o,position:t.position,rotation:t.rotation}),o}static clearHullCache(){this.hullCache.clear()}static clampPlayerToShipBounds(t,e,i){const o=this.getTransformedShipHull(e),n=D.closestPointOnPolygon(t,o),s=e.position,r=s.sub(n);if(r.length()<1e-6)return s;const l=r.normalize();return n.add(l.mul(i))}};u($,"hullCache",new Map);let B=$;const Y=new Map;function dt(a){var r;const t=`${a.id}`,e=Date.now(),i=Y.get(t);if(i&&e-i.lastUpdate<33)return i.polygon;let o=0,n=0;for(const l of a.modules)l.kind==="plank"&&((r=l.moduleData)==null?void 0:r.kind)==="plank"&&(n++,l.moduleData.health>0&&o++);let s;return n===0?s=a.hull.slice():o===0?s=[]:o/n<.5?s=a.hull.map(c=>c.mul(.7)):s=a.hull.slice(),Y.set(t,{polygon:s,lastUpdate:e}),s}function ht(a,t,e=0){const i=dt(t);if(i.length===0)return!1;const o=a.sub(t.position).rotate(-t.rotation);return ut(o,i,e)}function ut(a,t,e=0){if(t.length<3)return!1;let i=!1;const o=a.x,n=a.y;for(let s=0,r=t.length-1;s<t.length;r=s++){const l=t[s].x,c=t[s].y,h=t[r].x,f=t[r].y;c>n!=f>n&&o<(h-l)*(n-c)/(f-c)+l&&(i=!i)}if(!i&&e>0)for(let s=0;s<t.length;s++){const r=t[s],c=t[(s+1)%t.length].sub(r),h=a.sub(r);if(c.lengthSq()<1e-10)continue;const f=Math.max(0,Math.min(1,h.dot(c)/c.lengthSq())),m=r.add(c.mul(f));if(a.sub(m).length()<=e)return!0}return i}const V={CONFIRM_IN_TICKS:2,CONFIRM_OUT_TICKS:1,SWITCH_COOLDOWN_MS:50,EPSILON_FACTOR:1.5,PENETRATION_WEIGHT:10,VELOCITY_WEIGHT:1};function ft(){return{currentCarrierId:null,candidateStates:new Map,lastSwitchTime:0,switchCooldownMs:V.SWITCH_COOLDOWN_MS,confirmInTicks:V.CONFIRM_IN_TICKS,confirmOutTicks:V.CONFIRM_OUT_TICKS}}function mt(a,t,e,i){const o=[],n={...e};n.candidateStates=new Map(e.candidateStates);const s=V.EPSILON_FACTOR*a.radius;if(n.currentCarrierId!==null&&a.velocity.length()>R.PLAYER_SPEED*.8){const c=t.find(h=>h.id===n.currentCarrierId);if(c&&a.velocity.sub(c.velocity).length()>R.PLAYER_SPEED*.6)return console.log(`Player ${a.id} swimming fast but marked on-deck - forcing exit`),n.candidateStates.delete(n.currentCarrierId),o.push({type:"leftDeck",playerId:a.id,newCarrierId:null,oldCarrierId:n.currentCarrierId,timestamp:i}),o.push({type:"carrierChanged",playerId:a.id,newCarrierId:null,oldCarrierId:n.currentCarrierId,timestamp:i}),n.currentCarrierId=null,n.lastSwitchTime=i,{newState:n,events:o}}const r=new Map;if(n.currentCarrierId!==null){const c=t.find(h=>h.id===n.currentCarrierId);if(c&&a.position.distanceTo(c.position)>400)return n.candidateStates.delete(n.currentCarrierId),o.push({type:"leftDeck",playerId:a.id,newCarrierId:null,oldCarrierId:n.currentCarrierId,timestamp:i}),o.push({type:"carrierChanged",playerId:a.id,newCarrierId:null,oldCarrierId:n.currentCarrierId,timestamp:i}),n.currentCarrierId=null,n.lastSwitchTime=i,{newState:n,events:o}}for(const c of t){if(!yt(a,c,s))continue;const h=pt(a,c,s);if(h.penetrationDepth>0){const f=n.candidateStates.get(c.id),m=f?f.confirmationTicks+1:1;r.set(c.id,{shipId:c.id,penetrationDepth:h.penetrationDepth,relativeVelocity:h.relativeVelocity,confirmationTicks:m,lastDetected:i})}}for(const[c,h]of n.candidateStates.entries())r.has(c)||(h.confirmationTicks=Math.max(0,h.confirmationTicks-1));for(const[c,h]of r.entries())n.candidateStates.set(c,h);for(const[c,h]of n.candidateStates.entries())h.confirmationTicks===0&&!r.has(c)&&n.candidateStates.delete(c);const l=St(n,i);if(l!==n.currentCarrierId){const c=n.currentCarrierId;c!==null&&l===null&&(console.log(`Player ${a.id} fell off ship ${c}!`),o.push({type:"leftDeck",playerId:a.id,newCarrierId:l,oldCarrierId:c,timestamp:i})),l!==c&&(console.log(`Player ${a.id} carrier changed: ${c} -> ${l}`),o.push({type:"carrierChanged",playerId:a.id,newCarrierId:l,oldCarrierId:c,timestamp:i})),n.currentCarrierId=l,n.lastSwitchTime=i}return{newState:n,events:o}}function gt(a){let e=a.hull.slice();const i=a.modules.filter(n=>n.kind==="ladder");if(i.length===0)return e;const o=[...e];for(const n of i)if(n.moduleData&&n.moduleData.kind==="ladder"){const s=n.moduleData,r=n.localPos,l=s.width,c=s.length,h=s.extendDirection||Math.PI,f=d.from(Math.cos(h),Math.sin(h)),m=f.perp(),g=l/2,y=r.add(f.mul(c)),p=[r.add(m.mul(g)),r.add(m.mul(-g)),y.add(m.mul(-g)),y.add(m.mul(g))];o.push(...p)}return o}function pt(a,t,e){const o=a.position.sub(t.position).rotate(-t.rotation);if(!ht(a.position,t,e))return{penetrationDepth:0,relativeVelocity:0};const s=gt(t),r=D.distanceToPolygonEdge(o,s),l=a.velocity,c=t.velocity.add(o.perp().mul(t.angularVelocity)),h=l.sub(c).length();return{penetrationDepth:r,relativeVelocity:h}}function yt(a,t,e){const i=a.position.distanceTo(t.position),n=300+e+a.radius;return i<=n}function St(a,t){if(t-a.lastSwitchTime<a.switchCooldownMs){const o=a.currentCarrierId?a.candidateStates.get(a.currentCarrierId):null;if(o&&o.confirmationTicks>=a.confirmInTicks)return a.currentCarrierId;if(!o||o.confirmationTicks===0)return null}const i=[];for(const o of a.candidateStates.values())o.confirmationTicks>=a.confirmInTicks&&i.push(o);if(i.length===0){const o=a.currentCarrierId?a.candidateStates.get(a.currentCarrierId):null;return o&&o.confirmationTicks>0?a.currentCarrierId:null}return i.length===1||i.sort((o,n)=>{const s=n.penetrationDepth-o.penetrationDepth;if(Math.abs(s)>.1)return s>0?1:-1;const r=o.relativeVelocity-n.relativeVelocity;return Math.abs(r)>.1?r>0?1:-1:o.shipId-n.shipId}),i[0].shipId}const F={JUMP:1,INTERACT:2,DISMOUNT:4,DESTROY_PLANK:8};function vt(a,t,e){const i={tick:a.tick+1,ships:a.ships.map(r=>({...r})),players:a.players.map(r=>({...r})),cannonballs:a.cannonballs.map(r=>({...r})),timestamp:a.timestamp+e*1e3,carrierDetection:new Map(a.carrierDetection)};for(const r of i.ships)wt(r,e);const o=3,n=e/o;for(let r=0;r<o;r++){for(const l of i.ships)l.position=l.position.add(l.velocity.mul(n)),l.rotation+=l.angularVelocity*n;bt(i.ships)}const s=[];for(const r of i.players){const l=xt(r,i.ships,i.carrierDetection,t,e,i.timestamp);s.push(...l)}return i.carrierEvents=s,i}function wt(a,t){var C;const e=a.modules.find(M=>M.kind==="helm");let i=0;e&&e.moduleData&&(i=((C=e.moduleData.currentInput)==null?void 0:C.x)||0);const o=a.velocity.length(),n=5,s=40;let r;o<n?r=.05+o/n*.1:r=.15+Math.min(o/s,1)*.35;const l=1.5,c=i*r,h=.92;a.angularVelocity+=c*l*t,a.angularVelocity*=h,a.rotation=O.wrap(a.rotation+a.angularVelocity*t);let f=0,m=0;for(const M of a.modules)if(M.kind==="mast"&&M.moduleData){const I=M.moduleData,T=I.openness||0,E=I.windEfficiency||.8,z=T/100,H=Math.pow(z,.7)*E;f+=H,m++}const g=8e3,y=300;let p=y;if(m>0){const M=f/m,I=1+(m-1)*.1,T=1+f*.25,E=M*I*T;p=y+(g-y)*Math.min(E,1.25)}const v=d.from(Math.cos(a.rotation),Math.sin(a.rotation)).mul(p),S=60,k=v.div(S);a.velocity=a.velocity.add(k.mul(t));const P=.995,w=1-o*2e-4,b=Math.max(P*w,.98);a.velocity=a.velocity.mul(b)}function xt(a,t,e,i,o,n){let s=e.get(a.id);s||(s=ft(),e.set(a.id,s));const{newState:r,events:l}=mt(a,t,s,n);e.set(a.id,r);const c=r.currentCarrierId||0;a.carrierId=c,a.onDeck=c>0;const h=t.find(f=>f.id===c);return h&&a.onDeck?kt(a,h,i,o):Mt(a,t,i,o),l}function kt(a,t,e,i){const o=t.position.sub(t.velocity.mul(i)),n=O.wrap(t.rotation-t.angularVelocity*i),s=O.diff(t.rotation,n),r=a.position.sub(o);let l;if(Math.abs(s)>.1)l=r.rotate(s);else{const C=r.perp().mul(t.angularVelocity*i);l=r.add(C)}const c=t.position.add(l),f=e.movement.mul(R.PLAYER_SPEED),m=t.velocity.add(r.perp().mul(t.angularVelocity)),g=a.velocity.sub(m),y=Math.log(2)/R.ICE_DRIFT_HALF_LIFE,p=Math.exp(-y*i),x=g.mul(p),v=m.add(x),S=f.mul(i);a.velocity=v.add(S);const k=c.add(f.mul(i)),P=R.EPS_FACTOR*a.radius,w=(e.actions&F.JUMP)!==0;if(w&&c.sub(t.position).length()>120*.7){console.log(`Player ${a.id} jumping near ship edge - assisting exit`);const T=c.sub(t.position).normalize().mul(R.PLAYER_SPEED*.5*i);a.position=c.add(f.mul(i)).add(T);return}const b=B.sweptCircleVsPlankSegments(c,k,a.radius,a.velocity,t,P,i,!1,w);if(b.collided){a.position=b.newPosition,a.velocity=b.newVelocity;const C=.95;a.velocity=a.velocity.mul(C)}else a.position=k,!Pt(a.position,t)&&a.onDeck&&console.log(`Player ${a.id} fell through plank gap at position ${a.position.x.toFixed(1)}, ${a.position.y.toFixed(1)}!`)}function Pt(a,t){const e=a.sub(t.position).rotate(-t.rotation),i=10;return D.pointInPolygon(e,t.hull,i)}function Mt(a,t,e,i){const o=e.movement.mul(R.PLAYER_SPEED),n=.85,s=8;a.velocity=a.velocity.mul(n).add(o.mul(i*s));const r=10,c=d.from(.3,.1).normalize().mul(r*i);a.velocity=a.velocity.add(c);let f=a.position.add(a.velocity.mul(i)),m=a.velocity;for(const y of t){const p=R.EPS_FACTOR*a.radius;if(a.position.distanceTo(y.position)>400)continue;const S=B.sweptCircleVsPlankSegments(a.position,f,a.radius,m,y,p,i,!0,!1);if(S.collided){f=S.newPosition,m=S.newVelocity;break}}a.position=f,a.velocity=m;const g=R.PLAYER_SPEED*.7;a.velocity.lengthSq()>g*g&&(a.velocity=a.velocity.normalize().mul(g))}function Q(a){const t=K(a);let e;if(t&&t.moduleData){const o=t.moduleData;e=o.area&&Array.isArray(o.area)?o.area:a.hull}else e=a.hull;let i=0;for(const o of e){const n=o.length();i=Math.max(i,n)}return i+10}function bt(a){for(let t=0;t<a.length;t++)for(let e=t+1;e<a.length;e++){const i=a[t],o=a[e],n=i.position.sub(o.position).length(),s=Q(i),r=Q(o),l=s+r;if(n<l){const c=Ct(i,o);c.isColliding&&(Dt(i,o,c),Tt(i,o,c))}}}function Ct(a,t){const e=K(a),i=K(t);if(!e||!i)return It(a,t);const o=e.moduleData,n=i.moduleData,s=o&&o.area&&Array.isArray(o.area)?o.area:a.hull,r=n&&n.area&&Array.isArray(n.area)?n.area:t.hull,l=s.map(h=>h.rotate(a.rotation).add(a.position)),c=r.map(h=>h.rotate(t.rotation).add(t.position));return et(l,c,a.position,t.position)}function K(a){return a.modules.find(t=>t.kind==="deck")}function It(a,t){const e=a.hull.map(o=>o.rotate(a.rotation).add(a.position)),i=t.hull.map(o=>o.rotate(t.rotation).add(t.position));return et(e,i,a.position,t.position)}function et(a,t,e,i){const o=[];for(let l=0;l<a.length;l++){const c=a[l],f=a[(l+1)%a.length].sub(c);o.push(d.from(-f.y,f.x).normalize())}for(let l=0;l<t.length;l++){const c=t[l],f=t[(l+1)%t.length].sub(c);o.push(d.from(-f.y,f.x).normalize())}let n=1/0,s=d.zero();for(const l of o){const c=J(a,l),h=J(t,l),f=Math.min(c.max,h.max)-Math.max(c.min,h.min);if(f<=0)return{isColliding:!1,normal:d.zero(),penetration:0,contactPoint:d.zero()};f<n&&(n=f,s=l)}return i.sub(e).dot(s)<0&&(s=s.mul(-1)),{isColliding:!0,normal:s,penetration:n,contactPoint:e.add(i).mul(.5)}}function J(a,t){let e=1/0,i=-1/0;for(const o of a){const n=o.dot(t);e=Math.min(e,n),i=Math.max(i,n)}return{min:e,max:i}}function Dt(a,t,e){const i=e.normal,o=e.penetration,n=1e3,s=1e3,r=n+s,l=s/r,c=n/r;a.position=a.position.sub(i.mul(o*l)),t.position=t.position.add(i.mul(o*c));const f=t.velocity.sub(a.velocity).dot(i);if(f>0)return;const g=-(1+.05)*f/r,y=i.mul(g),p=y.mul(s),x=y.mul(n);a.velocity=a.velocity.sub(p),t.velocity=t.velocity.add(x);const v=Math.abs(f),S=e.contactPoint.sub(a.position),k=e.contactPoint.sub(t.position),P=Math.min(v*5e-4,.002),w=S.cross(p.mul(-1))*P,b=k.cross(x)*P;a.angularVelocity+=w,t.angularVelocity+=b;const C=Math.max(.7,1-v*.01),M=Math.max(.6,1-v*.015);a.velocity=a.velocity.mul(C),t.velocity=t.velocity.mul(C),a.angularVelocity*=M,t.angularVelocity*=M}function Tt(a,t,e){const i=e.penetration*10,o=50,n=Math.min(i*2,15);X(a,e.contactPoint,n,o),X(t,e.contactPoint,n,o)}function X(a,t,e,i){for(const o of a.modules){if(o.kind!=="plank"||!o.moduleData||o.moduleData.kind!=="plank")continue;const n=o.moduleData;if(n.health<=0)continue;const r=o.localPos.rotate(a.rotation).add(a.position).sub(t).length();if(r<=i){const l=1-r/i,c=e*l;n.health=Math.max(0,n.health-c),n.health<=0&&c>0?(console.log(`ðŸ’¥ Collision destroyed plank! (${c.toFixed(1)} damage)`),n.destroyed=!0):c>0&&console.log(`âš”ï¸ Collision damaged plank: ${n.health.toFixed(1)} health remaining`)}}}const L=class L{constructor(t){u(this,"config");u(this,"predictionHistory",[]);u(this,"rewindBuffer",[]);u(this,"authoritativeState",null);u(this,"lastAuthoritativeTick",0);u(this,"clientTick",0);u(this,"estimatedNetworkDelay",0);u(this,"serverTickOffset",0);u(this,"needsRollback",!1);u(this,"rollbackTick",0);u(this,"inputValidation",{totalInputs:0,invalidInputs:0,inputRateViolations:0,duplicateInputs:0,timestampAnomalies:0,lastInputTimestamp:0});u(this,"predictionMetrics",{rollbacksPerformed:0,averagePredictionError:0,maxPredictionError:0,correctionsApplied:0,serverMispredictions:0});this.config=t,this.initializeBuffers()}initializeBuffers(){this.rewindBuffer=[],this.predictionHistory=[]}update(t,e,i){if(this.clientTick++,e.movement&&typeof e.movement=="object"&&!("mul"in e.movement)){const n=e.movement;e.movement=d.from(n.x||0,n.y||0)}if(!this.validateInputFrame(e)){console.warn("ðŸš¨ Input validation failed, using previous input");const n=this.predictionHistory[this.predictionHistory.length-1];e=(n==null?void 0:n.inputFrame)||{tick:this.clientTick,movement:d.zero(),actions:0}}if(this.updateRewindBuffer(this.clientTick,t,e,i),this.storePredictionState(this.clientTick,t,e),!this.config.enablePrediction)return t;const o=this.simulateStep(t,e,i);return this.needsRollback?this.performRollback(o,i):o}onAuthoritativeState(t){this.authoritativeState=t,this.lastAuthoritativeTick=t.tick;const e=this.findPredictionState(t.tick);e&&this.statesDiffer(t,e.worldState)&&(console.log(`ðŸ”„ Server correction detected at tick ${t.tick}`),this.scheduleRollback(t.tick)),this.cleanupOldStates(t.tick)}getInterpolatedState(t){return!this.config.enableInterpolation||!this.authoritativeState?this.authoritativeState:this.authoritativeState}isPredictionEnabled(){return this.config.enablePrediction}getPredictionStats(){return{clientTick:this.clientTick,authoritativeTick:this.lastAuthoritativeTick,predictionHistory:this.predictionHistory.length,rollbacksPerformed:0}}simulateStep(t,e,i){return vt(t,e,i)}storePredictionState(t,e,i){const o={tick:t,worldState:this.cloneWorldState(e),inputFrame:{tick:i.tick,movement:i.movement.clone?i.movement.clone():d.from(i.movement.x,i.movement.y),actions:i.actions},timestamp:Date.now(),serverConfirmed:!1,predictionError:0,correctionApplied:!1};this.predictionHistory.push(o),this.predictionHistory.length>L.MAX_PREDICTION_HISTORY&&this.predictionHistory.shift()}findPredictionState(t){return this.predictionHistory.find(e=>e.tick===t)||null}statesDiffer(t,e){if(t.players.length!==e.players.length)return!0;for(let i=0;i<t.players.length;i++){const o=t.players[i],n=e.players[i];if(!o||!n)return!0;const s=o.position.sub(n.position).length();if(s>1)return console.log(`Player ${o.id} position diff: ${s}`),!0;if(o.onDeck!==n.onDeck||o.carrierId!==n.carrierId)return!0}if(t.ships.length!==e.ships.length)return!0;for(let i=0;i<t.ships.length;i++){const o=t.ships[i],n=e.ships[i];if(!o||!n||o.position.sub(n.position).length()>2)return!0}return!1}scheduleRollback(t){this.needsRollback=!0,this.rollbackTick=t}performRollback(t,e){if(!this.authoritativeState)return this.needsRollback=!1,t;console.log(`ðŸŽ¬ Performing rollback from tick ${this.rollbackTick}`);let i=this.cloneWorldState(this.authoritativeState);const o=this.predictionHistory.filter(n=>n.tick>this.rollbackTick&&n.tick<=this.clientTick);for(const n of o)i=this.simulateStep(i,n.inputFrame,e);return this.updatePredictionHistory(o,i),this.needsRollback=!1,i}updatePredictionHistory(t,e){if(t.length>0){const i=t[t.length-1];i.worldState=this.cloneWorldState(e)}}cleanupOldStates(t){const e=t-this.config.rollbackLimit;this.predictionHistory=this.predictionHistory.filter(i=>i.tick>=e)}cloneWorldState(t){return{tick:t.tick,timestamp:t.timestamp,ships:t.ships.map(e=>({...e,position:e.position?e.position.clone():d.zero(),velocity:e.velocity?e.velocity.clone():d.zero(),hull:e.hull?e.hull.map(i=>i?i.clone():d.zero()):[],modules:e.modules?e.modules.map(i=>({...i})):[]})),players:t.players.map(e=>({...e,position:e.position?e.position.clone():d.zero(),velocity:e.velocity?e.velocity.clone():d.zero()})),cannonballs:t.cannonballs.map(e=>({...e,position:e.position?e.position.clone():d.zero(),velocity:e.velocity?e.velocity.clone():d.zero(),firingVelocity:e.firingVelocity?e.firingVelocity.clone():d.zero(),smokeTrail:e.smokeTrail?e.smokeTrail.map(i=>({...i,position:i.position?i.position.clone():d.zero()})):[]})),carrierDetection:new Map(t.carrierDetection)}}validateInputFrame(t){const e=Date.now();this.inputValidation.totalInputs++,console.log(`ðŸ” Input validation check - Tick: ${t.tick}, Movement: (${t.movement.x.toFixed(3)}, ${t.movement.y.toFixed(3)}), Actions: ${t.actions}`);const i=Math.sqrt(t.movement.x*t.movement.x+t.movement.y*t.movement.y);if(i>1.5)return this.inputValidation.invalidInputs++,console.log(`âŒ Input rejected - Movement magnitude too high: ${i.toFixed(3)}`),!1;if(this.inputValidation.lastInputTimestamp>0){const o=e-this.inputValidation.lastInputTimestamp;(o>100||o<0)&&(this.inputValidation.timestampAnomalies++,console.log(`âš ï¸ Timestamp anomaly detected: ${o}ms delta`))}return this.inputValidation.lastInputTimestamp=e,console.log(`âœ… Input validation passed for tick ${t.tick}`),!0}updateRewindBuffer(t,e,i,o){const n={tick:t,worldState:this.cloneWorldState(e),inputFrame:{...i},timestamp:Date.now(),networkDelay:this.estimatedNetworkDelay};this.rewindBuffer.push(n),this.rewindBuffer.length>L.REWIND_BUFFER_SIZE&&this.rewindBuffer.shift()}getRewindBufferState(t){return this.rewindBuffer.find(e=>e.tick===t)||null}getEnhancedPredictionStats(){const t=this.rewindBuffer[0],e=this.rewindBuffer[this.rewindBuffer.length-1];return{prediction:this.predictionMetrics,inputValidation:this.inputValidation,rewindBuffer:{size:this.rewindBuffer.length,oldestTick:(t==null?void 0:t.tick)||0,newestTick:(e==null?void 0:e.tick)||0,coverage:e&&t?e.timestamp-t.timestamp:0}}}};u(L,"REWIND_BUFFER_SIZE",16),u(L,"MAX_PREDICTION_HISTORY",32);let U=L;class Et{constructor(t,e){u(this,"canvas");u(this,"config");u(this,"inputState");u(this,"actionMappings",[]);u(this,"currentInputFrame");u(this,"inputFrameCounter",0);u(this,"playerPosition",d.zero());u(this,"onInputFrame",null);u(this,"lastInteractionTime",0);u(this,"interactionCooldown",500);this.canvas=t,this.config=e,this.inputState={pressedKeys:new Set,mousePosition:d.from(t.width/2,t.height/2),mouseWorldPosition:d.zero(),leftMouseDown:!1,rightMouseDown:!1,leftMouseReleased:!1,gamepadConnected:!1,gamepadState:null},this.currentInputFrame={tick:0,movement:d.zero(),actions:0},this.setupEventListeners(),this.setupActionMappings()}update(t){this.updateGamepad(),this.generateInputFrame(),this.onInputFrame&&this.onInputFrame(this.currentInputFrame),this.resetFrameFlags()}updateMouseWorldPosition(t){this.inputState.mouseWorldPosition=t.clone()}setPlayerPosition(t){this.playerPosition=t.clone()}getCurrentInputFrame(){return{...this.currentInputFrame}}getMouseWorldPosition(){return this.inputState.mouseWorldPosition.clone()}isActionActive(t){const e=this.actionMappings.find(i=>i.action===t);return e?e.pressed:!1}updateConfig(t){this.config={...t},this.setupActionMappings(),console.log("ðŸŽ® Input configuration updated")}shutdown(){this.removeEventListeners(),console.log("ðŸŽ® Input manager shutdown")}setupEventListeners(){window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this)),this.canvas.addEventListener("mousemove",this.onMouseMove.bind(this)),this.canvas.addEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.addEventListener("wheel",this.onMouseWheel.bind(this)),this.canvas.addEventListener("contextmenu",this.onContextMenu.bind(this)),window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this)),console.log("ðŸŽ® Input event listeners setup")}removeEventListeners(){window.removeEventListener("keydown",this.onKeyDown.bind(this)),window.removeEventListener("keyup",this.onKeyUp.bind(this)),this.canvas.removeEventListener("mousemove",this.onMouseMove.bind(this)),this.canvas.removeEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.removeEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.removeEventListener("wheel",this.onMouseWheel.bind(this)),this.canvas.removeEventListener("contextmenu",this.onContextMenu.bind(this)),window.removeEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.removeEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this))}setupActionMappings(){this.actionMappings=[];for(const[t,e]of this.config.keyBindings.entries())this.actionMappings.push({action:t,keyCode:e,pressed:!1})}generateInputFrame(){console.log(`ðŸ” Debug - Player: (${this.playerPosition.x.toFixed(1)}, ${this.playerPosition.y.toFixed(1)}), Mouse: (${this.inputState.mouseWorldPosition.x.toFixed(1)}, ${this.inputState.mouseWorldPosition.y.toFixed(1)})`);const t=this.calculateMovementVector(this.playerPosition),e=this.calculateActionBitmask();this.currentInputFrame={tick:this.inputFrameCounter++,movement:t,actions:e},console.log(`ðŸ•¹ï¸ Input frame generated - Movement: (${t.x.toFixed(2)}, ${t.y.toFixed(2)}), Actions: ${e}, Keys: W=${this.isActionActive("move_forward")} S=${this.isActionActive("move_backward")} A=${this.isActionActive("move_left")} D=${this.isActionActive("move_right")}`)}calculateMovementVector(t){let e=d.zero();const i=this.isActionActive("move_forward"),o=this.isActionActive("move_backward"),n=this.isActionActive("move_left"),s=this.isActionActive("move_right");if(t&&(i||o||n||s)){const r=this.inputState.mouseWorldPosition,l=r.sub(t),c=l.lengthSq()>0?l.normalize():d.from(0,-1),h=d.from(-c.y,c.x);if(i&&(e=e.add(c)),o&&(e=e.add(c.mul(-1))),s&&(e=e.add(h)),n&&(e=e.add(h.mul(-1))),this.config.enableDebugLogging){const f=Math.sqrt(l.lengthSq());console.log(`ðŸ–±ï¸ Mouse-relative movement: Player(${t.x.toFixed(1)}, ${t.y.toFixed(1)}) -> Mouse(${r.x.toFixed(1)}, ${r.y.toFixed(1)}) Distance: ${f.toFixed(1)}`),console.log(`ðŸ§­ Forward: (${c.x.toFixed(2)}, ${c.y.toFixed(2)}), Right: (${h.x.toFixed(2)}, ${h.y.toFixed(2)})`),console.log(`âŒ¨ï¸ Keys: W=${i} S=${o} A=${n} D=${s} -> Movement: (${e.x.toFixed(2)}, ${e.y.toFixed(2)})`)}}else i&&(e=e.add(d.from(0,-1))),o&&(e=e.add(d.from(0,1))),n&&(e=e.add(d.from(-1,0))),s&&(e=e.add(d.from(1,0)));return e.lengthSq()>1&&(e=e.normalize()),e}calculateActionBitmask(){let t=0;return this.isActionActive("jump")&&(t|=F.JUMP),this.isActionActive("interact")&&this.canInteract()&&(t|=F.INTERACT,this.lastInteractionTime=Date.now()),this.isActionActive("dismount")&&this.canInteract()&&(t|=F.DISMOUNT,this.lastInteractionTime=Date.now()),this.isActionActive("destroy_plank")&&(t|=F.DESTROY_PLANK),t}canInteract(){return Date.now()-this.lastInteractionTime>this.interactionCooldown}resetFrameFlags(){this.inputState.leftMouseReleased=!1}updateGamepad(){if(!this.config.gamepadEnabled||!this.inputState.gamepadConnected)return;const e=navigator.getGamepads()[0];if(!e){this.inputState.gamepadConnected=!1;return}this.inputState.gamepadState={axes:Array.from(e.axes),buttons:e.buttons.map(i=>i.pressed)}}onKeyDown(t){this.inputState.pressedKeys.add(t.code);for(const e of this.actionMappings)e.keyCode===t.code&&(e.pressed=!0);switch(t.code){}}onKeyUp(t){this.inputState.pressedKeys.delete(t.code);for(const e of this.actionMappings)e.keyCode===t.code&&(e.pressed=!1)}onMouseMove(t){const e=this.canvas.getBoundingClientRect();this.inputState.mousePosition=d.from(t.clientX-e.left,t.clientY-e.top)}onMouseDown(t){t.preventDefault(),t.button===0?this.inputState.leftMouseDown=!0:t.button===2&&(this.inputState.rightMouseDown=!0)}onMouseUp(t){t.preventDefault(),t.button===0?(this.inputState.leftMouseDown=!1,this.inputState.leftMouseReleased=!0):t.button===2&&(this.inputState.rightMouseDown=!1)}onMouseWheel(t){t.preventDefault()}onContextMenu(t){t.preventDefault()}onGamepadConnected(t){console.log("ðŸŽ® Gamepad connected:",t.gamepad.id),this.inputState.gamepadConnected=!0}onGamepadDisconnected(t){console.log("ðŸŽ® Gamepad disconnected:",t.gamepad.id),this.inputState.gamepadConnected=!1,this.inputState.gamepadState=null}}const Z={helm:d.from(0,-15),"steering-wheel":d.from(0,-15),cannon:d.from(0,-20),mast:d.from(0,15),seat:d.from(0,0),ladder:d.from(0,-10),custom:d.zero()},tt={helm:30,"steering-wheel":30,cannon:25,mast:35,seat:20,ladder:25,custom:20};class Rt{constructor(){u(this,"mountedPlayers",new Map);u(this,"lastInteractionResults",[])}update(t,e){this.updateMountedPlayerPositions(t),this.lastInteractionResults=[],this.updateModuleSystems(t,e)}interactWithModule(t,e,i){const o=t.players.find(c=>c.id===e),{ship:n,module:s}=this.findModule(t,i),r=this.validateInteraction(o,n,s);return r.result!=="success"?r:this.mountedPlayers.get(e)!==void 0?this.dismountPlayer(t,e):this.isModuleOccupied(i)?{playerId:e,moduleId:i,result:"failed_occupied",message:"Module is already occupied"}:this.mountPlayer(t,e,i,o,n,s)}dismountPlayer(t,e){const i=this.mountedPlayers.get(e);if(i===void 0)return{playerId:e,moduleId:-1,result:"failed_invalid_module",message:"Player is not mounted to any module"};this.mountedPlayers.delete(e),t.players.find(n=>n.id===e);const o={playerId:e,moduleId:i,result:"success",message:"Dismounted successfully"};return this.lastInteractionResults.push(o),o}getNearbyInteractableModules(t,e){const i=t.players.find(s=>s.id===e);if(!i||!i.onDeck)return[];const o=t.ships.find(s=>s.id===i.carrierId);if(!o)return[];const n=[];for(const s of o.modules){if(s.kind==="deck")continue;const r=this.getModuleWorldPosition(o,s),l=i.position.sub(r).length(),c=tt[s.kind]||20;l<=c&&n.push(s)}return n}isPlayerMounted(t){return this.mountedPlayers.has(t)}getPlayerMountedModule(t,e){const i=this.mountedPlayers.get(e);if(i===void 0)return null;const{module:o}=this.findModule(t,i);return o}getLastInteractionResults(){return[...this.lastInteractionResults]}validateInteraction(t,e,i){if(!t)return{playerId:0,moduleId:-1,result:"failed_invalid_module",message:"Player not found"};if(!t.onDeck)return{playerId:t.id,moduleId:-1,result:"failed_not_on_deck",message:"Must be on deck to interact with modules"};if(!e||!i)return{playerId:t.id,moduleId:-1,result:"failed_invalid_module",message:"Module not found"};const o=this.getModuleWorldPosition(e,i),n=t.position.sub(o).length(),s=tt[i.kind]||20;return n>s?{playerId:t.id,moduleId:i.id,result:"failed_out_of_range",message:`Too far from module (${n.toFixed(1)} > ${s})`}:{playerId:t.id,moduleId:i.id,result:"success"}}mountPlayer(t,e,i,o,n,s){this.mountedPlayers.set(e,i);const r=this.getModuleWorldPosition(n,s),l=Z[s.kind]||d.zero(),c=r.add(l.rotate(n.rotation));o.position=c,o.velocity=d.zero();const h={playerId:e,moduleId:i,result:"success",message:`Mounted to ${s.kind} module`};return this.lastInteractionResults.push(h),h}findModule(t,e){for(const i of t.ships){const o=i.modules.find(n=>n.id===e);if(o)return{ship:i,module:o}}return{ship:null,module:null}}getModuleWorldPosition(t,e){return e.localPos.rotate(t.rotation).add(t.position)}isModuleOccupied(t){for(const[,e]of this.mountedPlayers)if(e===t)return!0;return!1}updateMountedPlayerPositions(t){for(const[e,i]of this.mountedPlayers){const o=t.players.find(r=>r.id===e),{ship:n,module:s}=this.findModule(t,i);if(o&&n&&s){const r=this.getModuleWorldPosition(n,s),l=Z[s.kind]||d.zero(),c=r.add(l.rotate(n.rotation));o.position=c,o.velocity=d.zero()}}}updateModuleSystems(t,e){for(const i of t.ships)for(const o of i.modules)switch(o.kind){case"cannon":this.updateCannonModule(o,e);break;case"mast":this.updateMastModule(o,e);break}}updateCannonModule(t,e){if(!t.moduleData||t.moduleData.kind!=="cannon")return;const i=t.moduleData;i.timeSinceLastFire!==void 0&&i.reloadTime!==void 0&&i.timeSinceLastFire<i.reloadTime&&(i.timeSinceLastFire+=e)}updateMastModule(t,e){!t.moduleData||t.moduleData.kind!=="mast"||t.moduleData}}class At{constructor(t,e){u(this,"config");u(this,"elements",new Map);u(this,"showDebugOverlay",!1);u(this,"showNetworkStats",!1);u(this,"showControlHints",!0);this.config=e,this.initializeUIElements(),this.setupEventListeners()}update(t){this.showDebugOverlay=this.config.debug.enabled,this.showNetworkStats=this.config.debug.showNetworkStats}render(t,e){const i=["hud","control_hints","network_stats","debug_overlay"];for(const o of i){const n=this.elements.get(o);if(n&&n.visible)try{n.render(t,e)}catch(s){console.error(`Error rendering UI element ${o}:`,s)}}}toggleDebugOverlay(){this.showDebugOverlay=!this.showDebugOverlay;const t=this.elements.get("debug_overlay");t&&(t.visible=this.showDebugOverlay)}toggleNetworkStats(){this.showNetworkStats=!this.showNetworkStats;const t=this.elements.get("network_stats");t&&(t.visible=this.showNetworkStats)}onCanvasResize(t,e){console.log(`ðŸ“± UI canvas resized to ${t}x${e}`)}shutdown(){this.removeEventListeners(),console.log("ðŸ–¥ï¸ UI manager shutdown")}initializeUIElements(){this.elements.set("hud",new zt),this.elements.set("debug_overlay",new Nt),this.elements.set("network_stats",new _t),this.elements.set("control_hints",new Ot),this.updateElementVisibility()}updateElementVisibility(){this.elements.get("hud").visible=!0,this.elements.get("debug_overlay").visible=this.showDebugOverlay,this.elements.get("network_stats").visible=this.showNetworkStats,this.elements.get("control_hints").visible=this.showControlHints}setupEventListeners(){window.addEventListener("keydown",this.onKeyDown.bind(this))}removeEventListeners(){window.removeEventListener("keydown",this.onKeyDown.bind(this))}onKeyDown(t){switch(t.code){case"KeyL":this.toggleDebugOverlay();break;case"F1":this.showControlHints=!this.showControlHints,this.updateElementVisibility();break}}}class zt{constructor(){u(this,"type","hud");u(this,"visible",!0)}render(t,e){const i=e.assignedPlayerId!==null&&e.assignedPlayerId!==void 0?e.worldState.players.find(n=>n.id===e.assignedPlayerId):e.worldState.players[0];if(!i)return;t.save(),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(10,10,320,120),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(10,10,320,120),t.fillStyle="#ffffff",t.font="bold 16px Consolas, monospace",t.textAlign="left",t.fillStyle="#00ff00",t.font="bold 18px Consolas, monospace",t.fillText(`POSITION: ${i.position.x.toFixed(1)}, ${i.position.y.toFixed(1)}`,20,35),t.fillStyle="#ffffff",t.font="14px Consolas, monospace",[`FPS: ${e.fps}`,`On Ship: ${i.onDeck?"Yes":"No"}`,`Carrier ID: ${i.carrierId}`,`Velocity: ${i.velocity.x.toFixed(1)}, ${i.velocity.y.toFixed(1)}`,`Network: ${e.networkStats.ping.toFixed(0)}ms`].forEach((n,s)=>{t.fillText(n,20,55+s*16)}),t.restore()}}class Nt{constructor(){u(this,"type","debug_overlay");u(this,"visible",!1)}render(t,e){const i=e.assignedPlayerId!==null&&e.assignedPlayerId!==void 0?e.worldState.players.find(s=>s.id===e.assignedPlayerId):e.worldState.players[0],o=e.camera.getState();if(!i)return;t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(10,10,400,300),t.fillStyle="#00ff00",t.font="14px monospace",t.textAlign="left",["=== DEBUG INFO ===",`Tick: ${e.worldState.tick}`,`Player Velocity: ${i.velocity.x.toFixed(2)}, ${i.velocity.y.toFixed(2)}`,`Camera Position: ${o.position.x.toFixed(1)}, ${o.position.y.toFixed(1)}`,`Camera Zoom: ${o.zoom.toFixed(2)}x`,`Ships: ${e.worldState.ships.length}`,`Cannonballs: ${e.worldState.cannonballs.length}`,"","=== CONTROLS ===","L - Toggle this overlay","F1 - Toggle control hints","WASD - Movement","Space - Jump off ship","E - Interact with modules"].forEach((s,r)=>{t.fillText(s,20,35+r*16)})}}class _t{constructor(){u(this,"type","network_stats");u(this,"visible",!1)}render(t,e){const i=e.networkStats;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(t.canvas.width-220,10,210,120),t.fillStyle="#00ffff",t.font="14px monospace",t.textAlign="left",["=== NETWORK ===",`Ping: ${i.ping}ms`,`Packet Loss: ${i.packetLoss.toFixed(1)}%`,`Sent: ${(i.bytesSent/1024).toFixed(1)}KB`,`Received: ${(i.bytesReceived/1024).toFixed(1)}KB`,`Messages: ${i.messagesSent}/${i.messagesReceived}`].forEach((n,s)=>{t.fillText(n,t.canvas.width-210,30+s*16)})}}class Ot{constructor(){u(this,"type","control_hints");u(this,"visible",!0)}render(t,e){t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(10,t.canvas.height-120,300,110),t.fillStyle="#ffff00",t.font="12px Arial",t.textAlign="left",["CONTROLS:","WASD - Move","Mouse - Look direction","Space - Jump off ship","E - Interact with modules","R - Dismount from modules","Q - Damage planks"].forEach((o,n)=>{t.fillText(o,20,t.canvas.height-105+n*14)})}}const N={CANNON_FIRE:"cannon_fire",WATER_SPLASH:"water_splash",WOOD_BREAK:"wood_break",SAIL_FLAP:"sail_flap",ROPE_CREAK:"rope_creak",FOOTSTEPS_WOOD:"footsteps_wood",MODULE_INTERACT:"module_interact"},q={MAIN_THEME:"main_theme",BATTLE_MUSIC:"battle_music",AMBIENT_OCEAN:"ambient_ocean"};class Lt{constructor(t){u(this,"config");u(this,"audioContext",null);u(this,"masterGain",null);u(this,"musicGain",null);u(this,"sfxGain",null);u(this,"voiceGain",null);u(this,"sources",new Map);u(this,"loadedBuffers",new Map);u(this,"listenerPosition",d.zero());this.config=t}async initialize(){if(!this.config.enabled){console.log("ðŸ”‡ Audio disabled by configuration");return}try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.connect(this.audioContext.destination),this.masterGain.gain.value=this.config.masterVolume,this.setupVolumeNodes(),await this.loadAudioAssets(),console.log("ðŸ”Š Audio system initialized")}catch(t){console.error("âŒ Failed to initialize audio system:",t)}}update(t){!this.audioContext||!this.config.enabled||(this.updateSpatialAudio(),this.cleanupFinishedSources())}playSFX(t,e,i=1){if(!this.canPlayAudio())return"";const o=this.loadedBuffers.get(t);if(!o)return console.warn(`Sound effect not found: ${t}`),"";const n=`sfx_${t}_${Date.now()}_${Math.random()}`,s={id:n,type:"sfx",buffer:o,source:null,gainNode:null,position:e==null?void 0:e.clone(),loop:!1,playing:!1};return this.playAudioSource(s,i),this.sources.set(n,s),n}playMusic(t,e=!0,i=1){if(!this.canPlayAudio())return"";this.stopAllMusic();const o=this.loadedBuffers.get(t);if(!o)return console.warn(`Music track not found: ${t}`),"";const n=`music_${t}`,s={id:n,type:"music",buffer:o,source:null,gainNode:null,loop:e,playing:!1};return this.playAudioSource(s,i),this.sources.set(n,s),n}stopAudio(t){const e=this.sources.get(t);!e||!e.source||(e.source.stop(),e.playing=!1)}stopAllMusic(){for(const[t,e]of this.sources)e.type==="music"&&e.playing&&this.stopAudio(t)}setListenerPosition(t){this.listenerPosition=t.clone()}updateConfig(t){this.config={...t},this.canPlayAudio()&&(this.masterGain.gain.value=t.masterVolume,this.musicGain.gain.value=t.musicVolume,this.sfxGain.gain.value=t.sfxVolume,this.voiceGain.gain.value=t.voiceVolume,console.log("ðŸ”Š Audio configuration updated"))}shutdown(){for(const[t,e]of this.sources)e.playing&&this.stopAudio(t);this.audioContext&&this.audioContext.state!=="closed"&&this.audioContext.close(),this.sources.clear(),this.loadedBuffers.clear(),console.log("ðŸ”‡ Audio system shutdown")}canPlayAudio(){return this.config.enabled&&this.audioContext!==null&&this.masterGain!==null}setupVolumeNodes(){!this.audioContext||!this.masterGain||(this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.masterGain),this.musicGain.gain.value=this.config.musicVolume,this.sfxGain=this.audioContext.createGain(),this.sfxGain.connect(this.masterGain),this.sfxGain.gain.value=this.config.sfxVolume,this.voiceGain=this.audioContext.createGain(),this.voiceGain.connect(this.masterGain),this.voiceGain.gain.value=this.config.voiceVolume)}async loadAudioAssets(){const t=[{id:N.CANNON_FIRE,duration:1},{id:N.WATER_SPLASH,duration:.5},{id:N.WOOD_BREAK,duration:.3},{id:N.SAIL_FLAP,duration:.8},{id:N.ROPE_CREAK,duration:1.2},{id:N.FOOTSTEPS_WOOD,duration:.2},{id:N.MODULE_INTERACT,duration:.1},{id:q.MAIN_THEME,duration:120},{id:q.BATTLE_MUSIC,duration:180},{id:q.AMBIENT_OCEAN,duration:300}];for(const e of t){const i=await this.createSampleBuffer(e.id,e.duration);i&&this.loadedBuffers.set(e.id,i)}console.log(`ðŸŽµ Loaded ${this.loadedBuffers.size} audio assets`)}async createSampleBuffer(t,e){if(!this.audioContext)return null;const i=this.audioContext.sampleRate,o=i*e,n=this.audioContext.createBuffer(2,o,i);for(let s=0;s<n.numberOfChannels;s++){const r=n.getChannelData(s);for(let l=0;l<o;l++){let c=0;if(t.includes("cannon")||t.includes("explosion"))c=(Math.random()*2-1)*Math.exp(-l/(o*.3))*.5;else if(t.includes("water")||t.includes("splash"))c=(Math.random()*2-1)*Math.exp(-l/(o*.5))*.3;else if(t.includes("music")||t.includes("theme")){const h=440*Math.pow(2,Math.sin(l/o*Math.PI*4)*.5);c=Math.sin(2*Math.PI*h*l/i)*.1}else c=Math.sin(2*Math.PI*440*l/i)*.2;r[l]=c}}return n}playAudioSource(t,e){if(!this.audioContext||!t.buffer)return;const i=this.audioContext.createBufferSource(),o=this.audioContext.createGain();i.buffer=t.buffer,i.loop=t.loop,o.gain.value=e;let n;switch(t.type){case"music":n=this.musicGain;break;case"sfx":n=this.sfxGain;break;case"voice":n=this.voiceGain;break;default:n=this.sfxGain;break}i.connect(o),o.connect(n),t.position&&this.config.spatialAudio&&this.applySpatialAudio(o,t.position),t.source=i,t.gainNode=o,t.playing=!0,i.onended=()=>{t.playing=!1},i.start()}applySpatialAudio(t,e){if(!this.audioContext)return;const i=this.listenerPosition.sub(e).length(),n=Math.max(0,1-i/500);t.gain.value*=n}updateSpatialAudio(){if(this.config.spatialAudio)for(const t of this.sources.values())t.playing&&t.position&&t.gainNode&&this.applySpatialAudio(t.gainNode,t.position)}cleanupFinishedSources(){var t;for(const[e,i]of this.sources)!i.playing&&i.source&&(i.source.disconnect(),(t=i.gainNode)==null||t.disconnect(),this.sources.delete(e))}}var _=(a=>(a.INITIALIZING="initializing",a.CONNECTING="connecting",a.CONNECTED="connected",a.IN_GAME="in_game",a.DISCONNECTED="disconnected",a.ERROR="error",a))(_||{});class Wt{constructor(t,e){u(this,"canvas");u(this,"config");u(this,"state","initializing");u(this,"renderSystem");u(this,"networkManager");u(this,"predictionEngine");u(this,"inputManager");u(this,"uiManager");u(this,"audioManager");u(this,"moduleInteractionSystem");u(this,"authoritativeWorldState",null);u(this,"predictedWorldState",null);u(this,"demoWorldState",null);u(this,"camera");u(this,"running",!1);u(this,"lastFrameTime",0);u(this,"accumulator",0);u(this,"clientTickDuration");u(this,"frameCount",0);u(this,"fpsTimer",0);u(this,"currentFPS",0);this.canvas=t,this.config=e,this.clientTickDuration=1e3/e.prediction.clientTickRate,console.log(`ðŸŽ® Client initialized with ${e.prediction.clientTickRate}Hz tick rate`)}async initialize(){try{this.state="initializing",console.log("âš¡ Initializing client systems..."),this.camera=new ct({width:this.canvas.width,height:this.canvas.height},{position:d.from(600,400),zoom:1,rotation:0}),this.renderSystem=new rt(this.canvas,this.config.graphics),await this.renderSystem.initialize(),this.networkManager=new lt(this.config.network),this.networkManager.setWorldStateHandler(this.onServerWorldState.bind(this)),this.networkManager.setConnectionStateHandler(this.onConnectionStateChanged.bind(this)),this.predictionEngine=new U(this.config.prediction),this.inputManager=new Et(this.canvas,this.config.input),this.inputManager.onInputFrame=this.onInputFrame.bind(this),this.setupMouseTracking(),this.uiManager=new At(this.canvas,this.config),this.audioManager=new Lt(this.config.audio),await this.audioManager.initialize(),this.moduleInteractionSystem=new Rt,this.setupCanvasResizeHandler(),console.log("âœ… All client systems initialized successfully")}catch(t){throw this.state="error",console.error("âŒ Failed to initialize client systems:",t),t}}async start(){if(this.running){console.warn("âš ï¸ Client is already running");return}try{console.log("ðŸš€ Starting client application..."),this.state="connecting";try{await this.networkManager.connect("Player"),console.log("âœ… Connected to physics server")}catch(t){console.warn("âš ï¸ Could not connect to physics server:",t),console.log("ðŸŽ® Running in offline mode - UI and local systems will work"),this.state="disconnected",this.demoWorldState=this.createDemoWorldState()}this.running=!0,this.lastFrameTime=performance.now(),requestAnimationFrame(this.gameLoop.bind(this)),console.log("âœ… Client application started successfully")}catch(t){throw this.state="error",console.error("âŒ Failed to start client application:",t),t}}shutdown(){var t,e,i,o,n;console.log("ðŸ›‘ Shutting down client application..."),this.running=!1,this.state="disconnected",(t=this.networkManager)==null||t.disconnect(),(e=this.audioManager)==null||e.shutdown(),(i=this.inputManager)==null||i.shutdown(),(o=this.uiManager)==null||o.shutdown(),(n=this.renderSystem)==null||n.shutdown(),console.log("âœ… Client application shutdown complete")}gameLoop(t){if(!this.running)return;const e=t-this.lastFrameTime;this.lastFrameTime=t;const i=Math.min(e,100);for(this.accumulator+=i,this.updateFPSTracking(e);this.accumulator>=this.clientTickDuration;)this.updateClient(this.clientTickDuration),this.accumulator-=this.clientTickDuration;this.updateVariableTimestep(i);const o=this.accumulator/this.clientTickDuration;this.renderFrame(o),requestAnimationFrame(this.gameLoop.bind(this))}updateClient(t){const e=t/1e3;if(this.inputManager.update(e),this.authoritativeWorldState&&this.state==="in_game"){if(this.predictedWorldState=this.predictionEngine.update(this.authoritativeWorldState,this.inputManager.getCurrentInputFrame(),e),this.predictedWorldState){this.updateCamera(this.predictedWorldState,e);const i=this.networkManager.getAssignedPlayerId(),o=i!==null?this.predictedWorldState.players.find(n=>n.id===i):this.predictedWorldState.players[0];o&&this.inputManager.setPlayerPosition(o.position)}this.moduleInteractionSystem.update(this.predictedWorldState||this.authoritativeWorldState,e)}}updateVariableTimestep(t){const e=t/1e3;this.uiManager.update(e),this.audioManager.update(e),this.renderSystem.update(e)}renderFrame(t){const e=this.predictedWorldState||this.authoritativeWorldState||this.demoWorldState;e?(this.renderSystem.renderWorld(e,this.camera,t),this.uiManager.render(this.renderSystem.getContext(),{worldState:e,camera:this.camera,fps:this.currentFPS,networkStats:this.networkManager.getStats(),config:this.config,assignedPlayerId:this.networkManager.getAssignedPlayerId()})):this.renderSystem.renderLoadingScreen(this.state,this.camera)}updateCamera(t,e){const i=this.networkManager.getAssignedPlayerId(),o=i!==null?t.players.find(n=>n.id===i):t.players[0];if(!o){console.warn(`No player found for camera following (assigned ID: ${i})`);return}this.camera.setPosition(o.position)}onInputFrame(t){this.networkManager.sendInput(t)}onServerWorldState(t){this.authoritativeWorldState=t,this.predictionEngine.onAuthoritativeState(t),this.state==="connected"&&(this.state="in_game",console.log("ðŸŽ® Entered game world"))}onConnectionStateChanged(t){t===W.CONNECTED?(this.state="connected",console.log("ðŸŒ Connected to server")):t===W.DISCONNECTED||t===W.ERROR?(this.state="disconnected",console.log("ðŸ”Œ Disconnected from server:",t)):t===W.CONNECTING&&(this.state="connecting",console.log("ðŸ”„ Connecting to server..."))}setupMouseTracking(){this.canvas.addEventListener("mousemove",t=>{const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top,n=this.camera.screenToWorld(d.from(i,o));console.log(`ðŸ–±ï¸ Mouse: screen(${i.toFixed(1)}, ${o.toFixed(1)}) -> world(${n.x.toFixed(1)}, ${n.y.toFixed(1)})`),this.inputManager.updateMouseWorldPosition(n)}),console.log("ðŸ–±ï¸ Mouse tracking initialized for directional movement")}setupCanvasResizeHandler(){new ResizeObserver(e=>{for(const i of e){const{width:o,height:n}=i.contentRect;this.canvas.width=o,this.canvas.height=n,this.camera.setViewport({width:o,height:n}),this.renderSystem.onCanvasResize(o,n),this.uiManager.onCanvasResize(o,n)}}).observe(this.canvas)}updateFPSTracking(t){this.frameCount++,this.fpsTimer+=t,this.fpsTimer>=1e3&&(this.currentFPS=Math.round(this.frameCount*1e3/this.fpsTimer),this.frameCount=0,this.fpsTimer=0)}getState(){return this.state}getConfig(){return this.config}updateConfig(t){this.config={...this.config,...t},this.renderSystem.updateConfig(this.config.graphics),this.audioManager.updateConfig(this.config.audio),this.inputManager.updateConfig(this.config.input),console.log("âš™ï¸ Client configuration updated")}createDemoWorldState(){return{tick:0,timestamp:Date.now(),ships:[{id:1,position:d.from(600,400),velocity:d.zero(),rotation:0,angularVelocity:0,hull:[d.from(-60,-20),d.from(60,-20),d.from(60,20),d.from(-60,20)],modules:[{id:1,kind:"deck",deckId:0,localPos:d.zero(),localRot:0,occupiedBy:null,stateBits:0},{id:2,kind:"helm",deckId:0,localPos:d.from(0,-10),localRot:0,occupiedBy:null,stateBits:0}]}],players:[{id:1,position:d.from(600,400),velocity:d.zero(),radius:8,carrierId:1,deckId:0,onDeck:!0}],cannonballs:[],carrierDetection:new Map}}}const G={network:{serverUrl:"ws://localhost:8080",maxReconnectAttempts:5,reconnectDelay:2e3,heartbeatInterval:3e4,timeoutDuration:1e4,protocol:"websocket",fallbackToWebSocket:!0},graphics:{targetFPS:60,vsync:!0,antialiasing:!0,particleQuality:"medium",shadowQuality:"medium",textureQuality:"high",renderDistance:2e3},audio:{masterVolume:1,musicVolume:.7,sfxVolume:.8,voiceVolume:1,enabled:!0,spatialAudio:!0},input:{mouseSensitivity:1,invertMouseY:!1,keyBindings:new Map([["move_forward","KeyW"],["move_backward","KeyS"],["move_left","KeyA"],["move_right","KeyD"],["jump","Space"],["interact","KeyE"],["dismount","KeyR"],["destroy_plank","KeyQ"],["toggle_debug","KeyL"],["toggle_plank_bounds","KeyP"],["toggle_collision_tracker","KeyT"],["toggle_water_mode","KeyN"],["toggle_camera_mode","KeyC"]]),gamepadEnabled:!0,gamepadDeadzone:.1,enableDebugLogging:!1},prediction:{clientTickRate:120,serverTickRate:30,interpolationBuffer:100,interpolationDelay:66,extrapolationLimit:50,rollbackLimit:10,predictionErrorThreshold:5,enablePrediction:!0,enableInterpolation:!0},debug:{enabled:!1,showNetworkStats:!1,showPerformanceStats:!1,showCollisionBounds:!1,showPlankBounds:!1,showCarrierDetection:!1,logLevel:"info",recordReplays:!1,maxReplayLength:300},canvas:{width:1920,height:1080}};async function j(){try{let a=function(){e.width=window.innerWidth,e.height=window.innerHeight};const t=Math.random().toString(36).substr(2,9);console.log(`ðŸ´â€â˜ ï¸ [${t}] Pirate MMO Client Starting...`);const e=document.getElementById("gameCanvas");if(!e)throw new Error("Canvas element #gameCanvas not found");a(),window.addEventListener("resize",a);const i={...G,...Ft(),canvas:{width:e.width,height:e.height}},o=new Wt(e,i);await o.initialize(),o.start(),console.log("âœ… Pirate MMO Client Started Successfully"),window.addEventListener("beforeunload",()=>{console.log("ðŸ›‘ Client Shutting Down..."),o.shutdown()})}catch(a){console.error("âŒ Failed to start Pirate MMO Client:",a);const t=document.createElement("div");t.style.cssText=`
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #ff4444; color: white; padding: 20px; border-radius: 10px;
      font-family: Arial, sans-serif; font-size: 16px; z-index: 10000;
    `,t.textContent=`Failed to start game: ${a instanceof Error?a.message:"Unknown error"}`,document.body.appendChild(t)}}function Ft(){const a=new URLSearchParams(window.location.search),t={};if(a.has("server")&&(t.network={...G.network,serverUrl:a.get("server")}),a.has("debug")&&(t.debug={...G.debug,enabled:a.get("debug")==="true"}),a.has("fps")){const e=parseInt(a.get("fps"),10);e>0&&e<=120&&(t.graphics={...G.graphics,targetFPS:e})}return t}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",j):j();j();
