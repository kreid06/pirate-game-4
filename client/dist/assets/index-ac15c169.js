var nt=Object.defineProperty;var it=(a,t,e)=>t in a?nt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var h=(a,t,e)=>(it(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class u{constructor(t=0,e=0){this.x=t,this.y=e}static zero(){return new u(0,0)}static from(t,e){return new u(t,e)}clone(){return new u(this.x,this.y)}add(t){return new u(this.x+t.x,this.y+t.y)}sub(t){return new u(this.x-t.x,this.y-t.y)}mul(t){return new u(this.x*t,this.y*t)}div(t){return new u(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}normalize(){const t=this.length();return t===0?u.zero():this.div(t)}perp(){return new u(-this.y,this.x)}rotate(t){const e=Math.cos(t),n=Math.sin(t);return new u(this.x*e-this.y*n,this.x*n+this.y*e)}distanceTo(t){return this.sub(t).length()}lerp(t,e){return this.add(t.sub(this).mul(e))}equals(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e}toString(){return`Vec2(${this.x.toFixed(3)}, ${this.y.toFixed(3)})`}}class ot{constructor(t){h(this,"ctx");h(this,"effects",[]);h(this,"quality","medium");h(this,"qualityMultipliers",{low:.5,medium:1,high:2});this.ctx=t}async initialize(){console.log("✨ Particle system initialized")}update(t){const e=t/1e3;for(let n=this.effects.length-1;n>=0;n--){const i=this.effects[n];this.updateEffect(i,e),i.particles.length===0&&this.effects.splice(n,1)}}render(t){this.ctx.save();for(const e of this.effects)this.renderEffect(e,t);this.ctx.restore()}createWaterSplash(t,e=1){const n=Math.floor(20*e*this.qualityMultipliers[this.quality]),i=[];for(let o=0;o<n;o++){const s=o/n*Math.PI*2,r=80+Math.random()*120,c=1.5+Math.random()*1;i.push({position:t.clone(),velocity:u.from(Math.cos(s)*r,Math.sin(s)*r),life:0,maxLife:c,size:2+Math.random()*3,color:"#87ceeb",alpha:.8,gravity:50})}this.effects.push({position:t.clone(),type:"water_splash",intensity:e,particles:i})}createSmokeTrail(t){if(Math.random()>.3)return;const e=[],n=Math.floor(2*this.qualityMultipliers[this.quality]);for(let i=0;i<n;i++){const o=Math.random()*Math.PI*2,s=10+Math.random()*20,r=2+Math.random()*1;e.push({position:t.add(u.from((Math.random()-.5)*5,(Math.random()-.5)*5)),velocity:u.from(Math.cos(o)*s,Math.sin(o)*s),life:0,maxLife:r,size:3+Math.random()*4,color:"#555555",alpha:.6,gravity:-10})}this.effects.push({position:t.clone(),type:"cannonball_smoke",intensity:1,particles:e})}createExplosion(t,e=1){const n=Math.floor(30*e*this.qualityMultipliers[this.quality]),i=[];for(let o=0;o<n;o++){const s=Math.random()*Math.PI*2,r=100+Math.random()*200,c=.5+Math.random()*1;i.push({position:t.clone(),velocity:u.from(Math.cos(s)*r,Math.sin(s)*r),life:0,maxLife:c,size:3+Math.random()*5,color:Math.random()>.5?"#ff6600":"#ffaa00",alpha:1,gravity:0})}this.effects.push({position:t.clone(),type:"explosion",intensity:e,particles:i})}updateQuality(t){this.quality=t,console.log(`✨ Particle quality set to: ${t}`)}shutdown(){this.effects=[],console.log("✨ Particle system shutdown")}updateEffect(t,e){for(let n=t.particles.length-1;n>=0;n--){const i=t.particles[n];if(i.life+=e,i.life>=i.maxLife){t.particles.splice(n,1);continue}this.updateParticle(i,e)}}updateParticle(t,e){t.position=t.position.add(t.velocity.mul(e)),t.velocity=t.velocity.add(u.from(0,t.gravity).mul(e));const n=t.life/t.maxLife;t.alpha=1-n,n>.5&&(t.size*=.95)}renderEffect(t,e){for(const n of t.particles){if(n.alpha<=.1||n.size<=.5||!e.isWorldPositionVisible(n.position,50))continue;const i=e.worldToScreen(n.position),o=e.getState(),s=n.size*o.zoom;s<1||(this.ctx.globalAlpha=n.alpha,this.ctx.fillStyle=n.color,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,Math.PI*2),this.ctx.fill())}this.ctx.globalAlpha=1}}class st{constructor(t){h(this,"ctx");h(this,"effects",[]);h(this,"nextEffectId",1);this.ctx=t}async initialize(){console.log("🌟 Effect renderer initialized")}update(t){const e=t/1e3;for(let n=this.effects.length-1;n>=0;n--){const i=this.effects[n];if(i.age+=e,i.age>=i.maxAge){this.effects.splice(n,1);continue}this.updateEffect(i,e)}}render(t){this.ctx.save();for(const e of this.effects)if(t.isWorldPositionVisible(e.position,100))switch(e.type){case"muzzle_flash":this.renderMuzzleFlash(e,t);break;case"water_wake":this.renderWaterWake(e,t);break;case"explosion_flash":this.renderExplosionFlash(e,t);break}this.ctx.restore()}createMuzzleFlash(t,e,n=1){const i={id:this.nextEffectId++,type:"muzzle_flash",position:t.clone(),direction:e,size:40*n,age:0,maxAge:.15,intensity:n};this.effects.push(i)}createWaterWake(t,e,n){const i={id:this.nextEffectId++,type:"water_wake",position:t.clone(),direction:e,width:n,points:[t.clone()],age:0,maxAge:5,intensity:1};this.effects.push(i)}createExplosionFlash(t,e=1){const n={id:this.nextEffectId++,type:"explosion_flash",position:t.clone(),age:0,maxAge:.3,intensity:e};this.effects.push(n)}shutdown(){this.effects=[],console.log("🌟 Effect renderer shutdown")}updateEffect(t,e){switch(t.type){case"water_wake":this.updateWaterWake(t,e);break}}updateWaterWake(t,e){if(t.age%.1<e){const i=t.points[t.points.length-1],o=50,s=i.add(u.from(Math.cos(t.direction)*o*.1,Math.sin(t.direction)*o*.1));t.points.push(s),t.points.length>50&&t.points.shift()}}renderMuzzleFlash(t,e){const n=e.worldToScreen(t.position),i=e.getState(),o=t.size*i.zoom,s=1-t.age/t.maxAge;this.ctx.save(),this.ctx.translate(n.x,n.y),this.ctx.rotate(t.direction-i.rotation);const r=this.ctx.createRadialGradient(0,0,0,0,0,o);r.addColorStop(0,`rgba(255, 255, 255, ${s})`),r.addColorStop(.5,`rgba(255, 200, 0, ${s*.8})`),r.addColorStop(1,"rgba(255, 100, 0, 0)"),this.ctx.fillStyle=r,this.ctx.fillRect(-o,-o*.3,o*2,o*.6),this.ctx.restore()}renderWaterWake(t,e){if(t.points.length<2)return;const n=e.getState(),i=Math.max(.1,1-t.age/t.maxAge);this.ctx.strokeStyle=`rgba(255, 255, 255, ${i*.3})`,this.ctx.lineWidth=t.width*n.zoom,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath();const o=e.worldToScreen(t.points[0]);this.ctx.moveTo(o.x,o.y);for(let s=1;s<t.points.length;s++){const r=e.worldToScreen(t.points[s]);this.ctx.lineTo(r.x,r.y)}this.ctx.stroke()}renderExplosionFlash(t,e){const n=e.worldToScreen(t.position),i=e.getState(),s=80*t.intensity*i.zoom,r=1-t.age/t.maxAge,c=this.ctx.createRadialGradient(0,0,0,n.x,n.y,s);c.addColorStop(0,`rgba(255, 255, 255, ${r})`),c.addColorStop(.3,`rgba(255, 150, 0, ${r*.8})`),c.addColorStop(.7,`rgba(255, 50, 0, ${r*.4})`),c.addColorStop(1,"rgba(255, 0, 0, 0)"),this.ctx.fillStyle=c,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,s,0,Math.PI*2),this.ctx.fill()}}class at{constructor(t,e){h(this,"canvas");h(this,"ctx");h(this,"config");h(this,"particleSystem");h(this,"effectRenderer");h(this,"renderQueue",[]);h(this,"waterPattern",null);this.canvas=t,this.config=e;const n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D rendering context");this.ctx=n,this.particleSystem=new ot(this.ctx),this.effectRenderer=new st(this.ctx)}async initialize(){console.log("🎨 Initializing render system..."),this.setupCanvasProperties(),await this.createWaterPattern(),await this.particleSystem.initialize(),await this.effectRenderer.initialize(),console.log("✅ Render system initialized")}update(t){this.particleSystem.update(t),this.effectRenderer.update(t)}renderWorld(t,e,n){this.clearCanvas(),this.drawWater(e),this.drawGrid(e),this.queueWorldObjects(t,e,n),this.executeRenderQueue(),this.particleSystem.render(e),this.effectRenderer.render(e)}renderLoadingScreen(t,e){this.clearCanvas(),this.ctx.fillStyle="#1e90ff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.font="48px Arial",this.ctx.textAlign="center";let n="Loading...";switch(t){case O.INITIALIZING:n="Initializing Game...";break;case O.CONNECTING:n="Connecting to Server...";break;case O.CONNECTED:n="Entering World...";break;case O.DISCONNECTED:n="Disconnected - Reconnecting...";break;case O.ERROR:n="Connection Error",this.ctx.fillStyle="#ff4444";break}this.ctx.fillText(n,this.canvas.width/2,this.canvas.height/2),t!==O.ERROR&&this.drawLoadingSpinner()}getContext(){return this.ctx}onCanvasResize(t,e){this.createWaterPattern()}updateConfig(t){this.config={...t},this.setupCanvasProperties(),this.particleSystem.updateQuality(t.particleQuality)}shutdown(){this.particleSystem.shutdown(),this.effectRenderer.shutdown()}setupCanvasProperties(){this.config.antialiasing?(this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high"):this.ctx.imageSmoothingEnabled=!1}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}async createWaterPattern(){const t=document.createElement("canvas");t.width=64,t.height=64;const e=t.getContext("2d"),n=e.createLinearGradient(0,0,64,64);n.addColorStop(0,"#1e90ff"),n.addColorStop(.5,"#4169e1"),n.addColorStop(1,"#1e90ff"),e.fillStyle=n,e.fillRect(0,0,64,64),e.globalCompositeOperation="overlay",e.fillStyle="#ffffff10";for(let i=0;i<10;i++)e.beginPath(),e.arc(Math.random()*64,Math.random()*64,Math.random()*5+2,0,Math.PI*2),e.fill();this.waterPattern=this.ctx.createPattern(t,"repeat")}drawWater(t){this.waterPattern?this.ctx.fillStyle=this.waterPattern:this.ctx.fillStyle="#1e90ff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawGrid(t){t.getState();const e=t.getWorldBounds();this.ctx.strokeStyle="#ffffff20",this.ctx.lineWidth=1;const n=100,i=Math.floor(e.min.x/n)*n,o=Math.ceil(e.max.x/n)*n,s=Math.floor(e.min.y/n)*n,r=Math.ceil(e.max.y/n)*n;for(let c=i;c<=o;c+=n){const l=t.worldToScreen(u.from(c,e.min.y)),d=t.worldToScreen(u.from(c,e.max.y));this.ctx.beginPath(),this.ctx.moveTo(l.x,l.y),this.ctx.lineTo(d.x,d.y),this.ctx.stroke()}for(let c=s;c<=r;c+=n){const l=t.worldToScreen(u.from(e.min.x,c)),d=t.worldToScreen(u.from(e.max.x,c));this.ctx.beginPath(),this.ctx.moveTo(l.x,l.y),this.ctx.lineTo(d.x,d.y),this.ctx.stroke()}}queueWorldObjects(t,e,n){this.renderQueue=[];for(const i of t.ships)this.queueRenderItem(1,"ships",()=>this.drawShip(i,e));for(const i of t.players)this.queueRenderItem(2,"players",()=>this.drawPlayer(i,e));for(const i of t.cannonballs)this.queueRenderItem(3,"cannonballs",()=>this.drawCannonball(i,e))}queueRenderItem(t,e,n,i=0){this.renderQueue.push({layer:t,layerName:e,renderFn:n,priority:i})}executeRenderQueue(){this.renderQueue.sort((t,e)=>t.layer!==e.layer?t.layer-e.layer:(t.priority||0)-(e.priority||0));for(const t of this.renderQueue)try{t.renderFn()}catch(e){console.error(`Error rendering ${t.layerName}:`,e)}}drawShip(t,e){if(!e.isWorldPositionVisible(t.position,200))return;this.ctx.save();const n=e.worldToScreen(t.position),i=e.getState();this.ctx.translate(n.x,n.y),this.ctx.scale(i.zoom,i.zoom),this.ctx.rotate(t.rotation-i.rotation),this.drawShipHull(t),this.ctx.strokeStyle="#ff0000",this.ctx.lineWidth=4/i.zoom,this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(80,0),this.ctx.stroke(),this.ctx.restore()}drawShipHull(t){if(t.hull.length!==0){this.ctx.strokeStyle="#8B4513",this.ctx.fillStyle="#DEB887",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(t.hull[0].x,t.hull[0].y);for(let e=1;e<t.hull.length;e++)this.ctx.lineTo(t.hull[e].x,t.hull[e].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}}drawPlayer(t,e){if(!e.isWorldPositionVisible(t.position,50))return;const n=e.worldToScreen(t.position),i=e.getState(),o=t.radius*i.zoom;this.ctx.fillStyle=t.onDeck?"#00ff00":"#ff0000",this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="#ffff00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y);const s=e.worldToScreen(t.position.add(t.velocity.mul(.1)));this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}drawCannonball(t,e){if(!e.isWorldPositionVisible(t.position,20))return;const n=e.worldToScreen(t.position),i=e.getState(),o=t.radius*i.zoom;this.ctx.fillStyle="#333333",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke()}drawLoadingSpinner(){const t=this.canvas.width/2,e=this.canvas.height/2+100,n=30,i=Date.now()/100;this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.arc(t,e,n,i,i+Math.PI*1.5),this.ctx.stroke()}}class rt{constructor(t,e){h(this,"viewport");h(this,"state");h(this,"targetPosition",null);h(this,"velocity",u.zero());this.viewport=t,this.state={position:e.position.clone(),zoom:e.zoom,rotation:e.rotation}}getState(){return{position:this.state.position.clone(),zoom:this.state.zoom,rotation:this.state.rotation}}setPosition(t){this.state.position=t.clone(),this.targetPosition=null}setZoom(t){this.state.zoom=Math.max(.1,Math.min(10,t))}setRotation(t){this.state.rotation=t}setTarget(t){this.targetPosition=t.clone()}followTarget(t,e,n){if(!t)return;const i=t.sub(this.state.position);if(i.lengthSq()<.1){this.state.position=t.clone(),this.velocity=u.zero();return}const o=e,s=2*Math.sqrt(o),r=i.mul(o).sub(this.velocity.mul(s));this.velocity=this.velocity.add(r.mul(n)),this.state.position=this.state.position.add(this.velocity.mul(n))}zoomBy(t,e){const n=this.screenToWorld(e),i=this.state.zoom*t;this.setZoom(i);const o=this.worldToScreen(n),s=e.sub(o),r=this.screenToWorldDelta(s);this.state.position=this.state.position.sub(r)}worldToScreen(t){const n=t.sub(this.state.position).mul(this.state.zoom),i=Math.cos(-this.state.rotation),o=Math.sin(-this.state.rotation);return u.from(n.x*i-n.y*o,n.x*o+n.y*i).add(u.from(this.viewport.width/2,this.viewport.height/2))}screenToWorld(t){const e=t.sub(u.from(this.viewport.width/2,this.viewport.height/2)),n=Math.cos(this.state.rotation),i=Math.sin(this.state.rotation);return u.from(e.x*n-e.y*i,e.x*i+e.y*n).mul(1/this.state.zoom).add(this.state.position)}screenToWorldDelta(t){const e=Math.cos(this.state.rotation),n=Math.sin(this.state.rotation);return u.from(t.x*e-t.y*n,t.x*n+t.y*e).mul(1/this.state.zoom)}getWorldBounds(){const t=this.screenToWorld(u.zero()),e=this.screenToWorld(u.from(this.viewport.width,0)),n=this.screenToWorld(u.from(0,this.viewport.height)),i=this.screenToWorld(u.from(this.viewport.width,this.viewport.height)),o=[t,e,n,i];let s=o[0].x,r=o[0].y,c=o[0].x,l=o[0].y;for(const d of o)s=Math.min(s,d.x),r=Math.min(r,d.y),c=Math.max(c,d.x),l=Math.max(l,d.y);return{min:u.from(s,r),max:u.from(c,l)}}isWorldPositionVisible(t,e=0){const n=this.getWorldBounds();return t.x>=n.min.x-e&&t.x<=n.max.x+e&&t.y>=n.min.y-e&&t.y<=n.max.y+e}setViewport(t){this.viewport={...t}}getViewport(){return{...this.viewport}}}const A=1;var W=(a=>(a.DISCONNECTED="disconnected",a.CONNECTING="connecting",a.CONNECTED="connected",a.RECONNECTING="reconnecting",a.ERROR="error",a))(W||{});class ct{constructor(t){h(this,"config");h(this,"socket",null);h(this,"connectionState","disconnected");h(this,"clientId");h(this,"playerId",0);h(this,"localSequence",0);h(this,"remoteSequence",0);h(this,"stats",{ping:0,packetLoss:0,bytesReceived:0,bytesSent:0,packetsReceived:0,packetsSent:0,messagesReceived:0,messagesSent:0,averageFPS:0,connectionState:"disconnected"});h(this,"lastPingTime",0);h(this,"serverTimeOffset",0);h(this,"lastSnapshotTime",0);h(this,"snapshotCount",0);h(this,"onWorldStateUpdate",null);h(this,"onConnectionStateChange",null);h(this,"onTextMessage",null);this.config=t,this.clientId=Math.floor(Math.random()*4294967295)}sendTextCommand(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){console.warn("Cannot send text command - not connected");return}this.socket.send(t),console.log(`📤 Sent text command: ${t}`)}async connect(t){if(this.connectionState!=="disconnected")throw new Error("Already connected or connecting");this.setConnectionState("connecting");try{const e=this.config.serverUrl.replace("udp://","ws://");console.log(`🔌 Attempting to connect to: ${e}/game`),this.socket=new WebSocket(`${e}/game`),this.socket.binaryType="arraybuffer",this.setupSocketHandlers(),await this.waitForConnection(),await this.sendHandshake(t)}catch(e){throw this.setConnectionState("error"),console.error("🚫 Connection failed:",e),new Error(`Failed to connect to server at ${this.config.serverUrl}: ${e}`)}}sendInput(t){if(this.connectionState!=="connected")return;const e={type:3,version:A,sequence:this.localSequence++,deltaTime:16,thrust:this.floatToQ15(t.movement.y),turn:this.floatToQ15(t.movement.x),actions:t.actions,clientTime:performance.now(),checksum:0},n=this.serializePacket(e),i=this.calculateChecksum(n,n.byteLength-2);new DataView(n).setUint16(n.byteLength-2,i,!0),this.socket&&this.socket.readyState===WebSocket.OPEN&&(this.socket.send(n),this.stats.bytesSent+=n.byteLength,this.stats.packetsSent++,this.stats.messagesSent++)}setWorldStateHandler(t){this.onWorldStateUpdate=t}setConnectionStateHandler(t){this.onConnectionStateChange=t}setTextMessageHandler(t){this.onTextMessage=t}getStats(){return this.stats.connectionState=this.connectionState,{...this.stats}}disconnect(){this.socket&&(this.socket.close(),this.socket=null),this.setConnectionState("disconnected")}setupSocketHandlers(){this.socket&&(this.socket.onopen=t=>{console.log("🔗 WebSocket connected to server")},this.socket.onmessage=t=>{t.data instanceof ArrayBuffer?(this.handleBinaryMessage(t.data),this.stats.bytesReceived+=t.data.byteLength,this.stats.packetsReceived++,this.stats.messagesReceived++):typeof t.data=="string"&&(console.log(`📥 Received text message: ${t.data}`),this.handleTextMessage(t.data),this.stats.bytesReceived+=t.data.length,this.stats.packetsReceived++,this.stats.messagesReceived++)},this.socket.onerror=t=>{console.error("❌ WebSocket error:",t),this.setConnectionState("error")},this.socket.onclose=t=>{console.log("🔌 WebSocket disconnected:",t.code,t.reason),this.setConnectionState("disconnected")})}async waitForConnection(){return new Promise((t,e)=>{if(!this.socket){e(new Error("No socket"));return}if(this.socket.readyState===WebSocket.OPEN){t();return}const n=setTimeout(()=>{e(new Error(`Connection timeout after 10 seconds. Is the server running at ${this.config.serverUrl}?`))},1e4);this.socket.addEventListener("open",()=>{clearTimeout(n),t()},{once:!0}),this.socket.addEventListener("error",i=>{clearTimeout(n),e(new Error(`WebSocket connection failed. Server may not be running or accessible at ${this.config.serverUrl}`))},{once:!0})})}async sendHandshake(t){const e={type:1,version:A,clientId:this.clientId,playerName:t.substring(0,15),checksum:0},n=this.serializePacket(e),i=this.calculateChecksum(n,n.byteLength-2);new DataView(n).setUint16(n.byteLength-2,i,!0),this.socket&&this.socket.readyState===WebSocket.OPEN&&(this.socket.send(n),this.stats.bytesSent+=n.byteLength,this.stats.packetsSent++,this.stats.messagesSent++),await this.waitForHandshakeResponse()}async waitForHandshakeResponse(){return new Promise((t,e)=>{const n=setTimeout(()=>{e(new Error("Handshake timeout"))},5e3),i=this.onConnectionStateChange;this.onConnectionStateChange=o=>{o==="connected"?(clearTimeout(n),this.onConnectionStateChange=i,t()):o==="error"&&(clearTimeout(n),this.onConnectionStateChange=i,e(new Error("Handshake failed")))}})}handleBinaryMessage(t){const e=new DataView(t),n=e.getUint8(0);switch(n){case 2:this.handleServerHandshake(e);break;case 4:this.handleServerSnapshot(e);break;case 6:this.handleHeartbeat(e);break;default:console.warn("Unknown binary packet type:",n)}}handleTextMessage(t){console.log(`📝 Processing text message: ${t}`);try{const e=JSON.parse(t);e.type==="WELCOME"?(console.log(`🎮 Welcome message received for player ${e.player_id}`),this.playerId=e.player_id,this.connectionState==="connecting"&&this.setConnectionState("connected")):e.type==="GAME_STATE"&&console.log(`🗺️ Game state received: tick ${e.tick}`)}catch{console.log(t==="PONG"?"🏓 PONG received":`📨 Text response: ${t}`)}this.onTextMessage&&this.onTextMessage(t)}handleServerHandshake(t){const n=t.getUint16(8,!0),i=new ArrayBuffer(10),o=new DataView(i);for(let c=0;c<10;c++)o.setUint8(c,t.getUint8(c));const s=this.calculateChecksum(i,10-2);n!==s&&console.warn("🚨 Server handshake checksum mismatch");const r={type:t.getUint8(0),version:t.getUint8(1),playerId:t.getUint16(2,!0),serverTime:t.getUint32(4,!0),checksum:n};if(r.version!==A){console.error("🚨 Protocol version mismatch: expected",A,"got",r.version),this.setConnectionState("error");return}this.playerId=r.playerId,this.serverTimeOffset=r.serverTime-performance.now(),console.log(`🏴‍☠️ Connected as player ${this.playerId}, server time offset: ${this.serverTimeOffset}ms`),this.setConnectionState("connected")}handleServerSnapshot(t){let e=0;const n={type:t.getUint8(e++),version:t.getUint8(e++),serverTime:t.getUint32(e,!0),baseId:0,snapId:0,aoiCell:0,entityCount:0,flags:0,checksum:0};e+=4,n.baseId=t.getUint16(e,!0),e+=2,n.snapId=t.getUint16(e,!0),e+=2,n.aoiCell=t.getUint16(e,!0),e+=2,n.entityCount=t.getUint8(e++),n.flags=t.getUint8(e++),n.checksum=t.getUint16(e,!0),e+=2;const i=[];for(let r=0;r<n.entityCount;r++){const c={entityId:t.getUint16(e,!0),posX:0,posY:0,velX:0,velY:0,rotation:0,stateFlags:0,reserved:0};e+=2,c.posX=t.getUint16(e,!0),e+=2,c.posY=t.getUint16(e,!0),e+=2,c.velX=t.getUint16(e,!0),e+=2,c.velY=t.getUint16(e,!0),e+=2,c.rotation=t.getUint16(e,!0),e+=2,c.stateFlags=t.getUint8(e++),c.reserved=t.getUint8(e++),i.push(c)}const o=this.snapshotToWorldState(n,i);this.onWorldStateUpdate&&this.onWorldStateUpdate(o);const s=performance.now();if(this.lastSnapshotTime>0){const c=1e3/(s-this.lastSnapshotTime);this.stats.averageFPS=this.stats.averageFPS*.9+c*.1}this.lastSnapshotTime=s,this.snapshotCount++}handleHeartbeat(t){t.getUint32(4,!0);const e=performance.now();this.stats.ping=e-this.lastPingTime,this.sendHeartbeat()}serializePacket(t){let e,n,i=0;switch(t.type){case 1:e=new ArrayBuffer(24),n=new DataView(e),n.setUint8(i++,t.type),n.setUint8(i++,t.version||A),n.setUint32(i,t.clientId,!0),i+=4;const o=new TextEncoder().encode(t.playerName),s=new Uint8Array(e,i,16);s.fill(0),s.set(o.slice(0,15)),i+=16,n.setUint16(i,t.checksum||0,!0);break;case 3:e=new ArrayBuffer(18),n=new DataView(e),n.setUint8(i++,t.type),n.setUint8(i++,t.version||A),n.setUint16(i,t.sequence,!0),i+=2,n.setUint16(i,t.deltaTime,!0),i+=2,n.setInt16(i,t.thrust,!0),i+=2,n.setInt16(i,t.turn,!0),i+=2,n.setUint16(i,t.actions,!0),i+=2,n.setUint32(i,t.clientTime,!0),i+=4,n.setUint16(i,t.checksum||0,!0);break;case 6:e=new ArrayBuffer(6),n=new DataView(e),n.setUint8(i++,t.type),n.setUint8(i++,t.version||A),n.setUint32(i,t.clientTime,!0);break;default:throw new Error(`Unknown packet type: ${t.type}`)}return e}snapshotToWorldState(t,e){const n=[],i=[],o=[];for(const s of e){const r=new u(this.unquantizePosition(s.posX),this.unquantizePosition(s.posY)),c=new u(this.unquantizeVelocity(s.velX),this.unquantizeVelocity(s.velY)),l=this.unquantizeRotation(s.rotation);s.entityId<1e3?n.push({id:s.entityId,position:r,velocity:c,rotation:l,angularVelocity:0,hull:[],modules:[]}):i.push({id:s.entityId,position:r,velocity:c,firingVelocity:c.clone(),radius:.1,maxRange:100,distanceTraveled:0,timeAlive:0,firedFrom:0,smokeTrail:[]})}return{tick:t.snapId,ships:n,cannonballs:i,players:o,timestamp:t.serverTime,carrierDetection:new Map}}sendHeartbeat(){const t={type:6,version:A,clientTime:performance.now()},e=this.serializePacket(t);this.socket&&this.socket.readyState===WebSocket.OPEN&&(this.socket.send(e),this.stats.bytesSent+=e.byteLength,this.stats.packetsSent++,this.stats.messagesSent++),this.lastPingTime=performance.now()}setConnectionState(t){this.connectionState!==t&&(this.connectionState=t,this.onConnectionStateChange&&this.onConnectionStateChange(t))}floatToQ15(t){return Math.round(Math.max(-1,Math.min(1,t))*32767)}q15ToFloat(t){return t/32767}quantizePosition(t){return Math.round(t*512+32768)&65535}unquantizePosition(t){return(t-32768)/512}quantizeVelocity(t){return Math.round(t*256+32768)&65535}unquantizeVelocity(t){return(t-32768)/256}quantizeRotation(t){for(;t<0;)t+=2*Math.PI;for(;t>=2*Math.PI;)t-=2*Math.PI;return Math.round(t*1024/(2*Math.PI))&65535}unquantizeRotation(t){return t*(2*Math.PI)/1024}calculateChecksum(t,e){const n=new Uint8Array(t,0,e);let i=0;for(let o=0;o<e;o++)i+=n[o],i=(i&65535)+(i>>16);return~i&65535}}class _{static wrap(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}static diff(t,e){return _.wrap(t-e)}static lerp(t,e,n){const i=_.diff(e,t);return _.wrap(t+i*n)}static toRadians(t){return t*Math.PI/180}static toDegrees(t){return t*180/Math.PI}}class T{static pointInPolygon(t,e,n=0){if(e.length<3)return!1;let i=!1;const o=e.length;for(let s=0,r=o-1;s<o;r=s++){const c=e[s],l=e[r];if(c.y>t.y!=l.y>t.y){const d=(l.x-c.x)*(t.y-c.y)/(l.y-c.y)+c.x;t.x<d&&(i=!i)}}if(!i&&n>0)for(let s=0;s<o;s++){const r=(s+1)%o;if(T.pointToSegmentDistance(t,e[s],e[r])<=n)return!0}return i}static pointToSegmentDistance(t,e,n){const i=n.sub(e),o=i.length();if(o===0)return t.distanceTo(e);const s=Math.max(0,Math.min(1,t.sub(e).dot(i)/o)),r=e.add(i.mul(s));return t.distanceTo(r)}static closestPointOnPolygon(t,e){if(e.length===0)return t.clone();if(e.length===1)return e[0].clone();let n=e[0].clone(),i=t.distanceTo(e[0]);for(let o=0;o<e.length;o++){const s=(o+1)%e.length,r=e[o],l=e[s].sub(r),d=l.lengthSq();if(d===0){const y=t.distanceTo(r);y<i&&(i=y,n=r.clone());continue}const f=Math.max(0,Math.min(1,t.sub(r).dot(l)/d)),m=r.add(l.mul(f)),p=t.distanceTo(m);p<i&&(i=p,n=m)}return n}static sweptCircleVsSegment(t,e,n,i,o){const s={hit:!1,time:1,point:u.zero(),normal:u.zero()},r=e.sub(t),c=o.sub(i),l=c.perp().normalize();if(r.dot(l)>=0)return s;const d=t.sub(i).dot(l),f=e.sub(i).dot(l);if(Math.abs(d)<=n||Math.abs(f)<=n){const m=(Math.abs(d)-n)/Math.abs(r.dot(l));if(m>=0&&m<=1){const p=t.add(r.mul(m)),y=c.lengthSq();if(y>0){const g=p.sub(i).dot(c)/y;g>=0&&g<=1&&(s.hit=!0,s.time=m,s.point=i.add(c.mul(g)),s.normal=l.mul(d<0?-1:1))}}}return s}static slideAlongPolygon(t,e,n,i,o){let s=t.clone(),r=e.clone();const c=t.add(e.mul(o));for(let l=0;l<3;l++){let d=null,f=1;for(let g=0;g<i.length;g++){const x=(g+1)%i.length,w=T.sweptCircleVsSegment(s,c,n,i[g],i[x]);w.hit&&w.time<f&&(f=w.time,d=w)}if(!d){s=c;break}const m=c.sub(s);s=s.add(m.mul(d.time));const p=m.mul(1-d.time),y=p.sub(d.normal.mul(p.dot(d.normal)));if(r=y.div(o),y.lengthSq()<.001)break}return{newPosition:s,newVelocity:r}}static distanceToPolygonEdge(t,e){if(e.length<3)return 0;let n=1/0,i=!1;for(let o=0,s=e.length-1;o<e.length;s=o++){const r=e[o],c=e[s];r.y>t.y!=c.y>t.y&&t.x<(c.x-r.x)*(t.y-r.y)/(c.y-r.y)+r.x&&(i=!i)}for(let o=0;o<e.length;o++){const s=(o+1)%e.length,r=e[o],l=e[s].sub(r),d=l.lengthSq();if(d===0){const y=t.distanceTo(r);n=Math.min(n,y);continue}const f=Math.max(0,Math.min(1,t.sub(r).dot(l)/d)),m=r.add(l.mul(f)),p=t.distanceTo(m);n=Math.min(n,p)}return i?n:-n}}const R={SIM_TICK_RATE:60,SNAPSHOT_RATE:15,INTERP_BUFFER_MS:120,EPS_FACTOR:.03,N_IN:3,N_OUT:8,SWITCH_COOLDOWN_MS:200,HISTORY_TICKS:20,ICE_DRIFT_HALF_LIFE:.35,PLAYER_SPEED:200,PLAYER_RADIUS:8,CANNONBALL_SPEED:400,CANNONBALL_RANGE:800,CANNONBALL_RADIUS:8,CANNONBALL_RELOAD_TIME:3,SPLASH_RADIUS:50},z=[],V=class V{static trackCollision(t,e,n,i,o,s=!0,r){z.push({timestamp:Date.now(),playerPosition:t,collisionPoint:e,normal:n,penetrationDepth:i,slideDistance:o,isPlankCollision:s,plankId:r});const c=Date.now()-5e3;for(;z.length>0&&z[0].timestamp<c;)z.shift();z.length>100&&z.splice(0,50)}static getRecentCollisions(){return[...z]}static clearCollisionTracking(){z.length=0}static sweptCircleVsPolygon(t){const{startPos:e,endPos:n,radius:i,velocity:o,polygon:s,epsilon:r}=t,c=i+r,l=T.pointInPolygon(e,s,c),d=T.pointInPolygon(n,s,c);return l&&d?{newPosition:n,newVelocity:o,collided:!1,normal:u.zero(),penetrationDepth:0,contactPoint:n,slideDistance:0}:l&&!d?this.handleExitCollision(t):!l&&!d?this.handleEntryOrSlide(t):this.handleEntry(t)}static handleExitCollision(t){const{startPos:e,endPos:n,radius:i,velocity:o,polygon:s,epsilon:r}=t,c=i+r,l=n.sub(e);let d=null,f=1/0;for(let y=0;y<s.length;y++){const g=s[y],x=s[(y+1)%s.length],w=this.rayVsLineSegment(e,l,g,x,c);w&&w.t<f&&w.t>=0&&w.t<=1&&(f=w.t,d={edge:[g,x],t:w.t,normal:w.normal})}if(!d)return this.clampToClosestPoint(t);const m=e.add(l.mul(d.t)),p=this.calculateSlideVelocity(o,d.normal);return{newPosition:m,newVelocity:p,collided:!0,normal:d.normal,penetrationDepth:0,contactPoint:m,slideDistance:p.length()*t.dt}}static handleEntryOrSlide(t){return this.sweptCirclePolygon(t)}static sweptCirclePolygon(t){const{startPos:e,endPos:n,radius:i,polygon:o,epsilon:s,velocity:r}=t,c=i+s,l=n.sub(e),d=l.length();if(d<1e-6)return this.clampToClosestPoint(t);const f=l.normalize();let m=1/0,p=u.zero(),y=e;for(let g=0;g<o.length;g++){const x=o[g],S=o[(g+1)%o.length].sub(x),P=S.length();if(P<1e-6)continue;const k=S.normalize(),v=u.from(-k.y,k.x),b=-f.dot(v);if(b<=0)continue;const I=(e.sub(x).dot(v)-c)/b;if(I<0||I>d/r.length())continue;const D=e.add(f.mul(I*r.length())),L=D.sub(x).dot(k);L>=0&&L<=P&&I<m&&(m=I,p=v,y=D)}for(const g of o){const x=e.sub(g),w=l.dot(l),S=2*x.dot(l),P=x.dot(x)-c*c,k=S*S-4*w*P;if(k>=0){const v=(-S-Math.sqrt(k))/(2*w),b=(-S+Math.sqrt(k))/(2*w),M=v>=0&&v<=1?v:b>=0&&b<=1?b:-1;if(M>=0&&M<m/d){const C=e.add(l.mul(M)),I=C.sub(g).normalize();m=M*d,p=I,y=C}}}if(m<1/0){const g=f.sub(p.mul(f.dot(p))),x=d-m,w=g.mul(r.length());return{newPosition:y.add(g.mul(x)),newVelocity:w,collided:!0,normal:p,penetrationDepth:0,contactPoint:y,slideDistance:x}}return{newPosition:n,newVelocity:r,collided:!1,normal:u.zero(),penetrationDepth:0,contactPoint:n,slideDistance:0}}static handleEntry(t){return{newPosition:t.endPos,newVelocity:t.velocity,collided:!1,normal:u.zero(),penetrationDepth:0,contactPoint:t.endPos,slideDistance:0}}static clampToClosestPoint(t){const{endPos:e,radius:n,polygon:i,epsilon:o}=t,s=n+o,r=T.closestPointOnPolygon(e,i),c=e.sub(r),l=c.length();if(l<s){const d=l>0?c.normalize():u.from(0,-1);return{newPosition:r.add(d.mul(s)),newVelocity:u.zero(),collided:!0,normal:d,penetrationDepth:s-l,contactPoint:r,slideDistance:0}}return{newPosition:e,newVelocity:t.velocity,collided:!1,normal:u.zero(),penetrationDepth:0,contactPoint:e,slideDistance:0}}static rayVsLineSegment(t,e,n,i,o){const s=i.sub(n),r=s.length();if(r<1e-10)return null;const l=s.normalize().perp(),f=n.add(l.mul(o)).sub(t),m=e.length();if(m<1e-10)return null;const p=e.normalize(),y=p.x*s.y-p.y*s.x;if(Math.abs(y)<1e-10)return null;const g=(f.x*s.y-f.y*s.x)/y,x=(f.x*p.y-f.y*p.x)/y;return x>=0&&x<=r&&g>=0?{t:g/m,normal:l.mul(-1)}:null}static calculateSlideVelocity(t,e){const n=t.dot(e);return n>=0?t:t.sub(e.mul(n))}static resolvePenetration(t,e,n,i){const o=e.length()+i;if(T.pointInPolygon(t,n,o)){const s=T.closestPointOnPolygon(t,n),r=t.sub(s),c=r.length(),l=o-c;if(l>0){const d=c>0?r.normalize():u.from(0,-1);return{newPosition:s.add(d.mul(o)),penetrationDepth:l,normal:d}}}return{newPosition:t,penetrationDepth:0,normal:u.zero()}}static createPlankCollisionSegments(t){const e=[],n=t.modules.filter(i=>i.kind!=="plank"||!i.moduleData||i.moduleData.kind!=="plank"?!1:i.moduleData.health>0);for(const i of n)if(i.moduleData&&i.moduleData.kind==="plank"){const o=i.moduleData,s=i.localPos,r=i.localRot,c=o.length/2,l=o.width/2,m=[u.from(-c,-l),u.from(c,-l),u.from(c,l),u.from(-c,l)].map(p=>p.rotate(r).add(s)).map(p=>p.rotate(t.rotation).add(t.position));for(let p=0;p<m.length;p++){const y=m[p],g=m[(p+1)%m.length];e.push({start:y,end:g,plankId:i.id})}}return e}static sweptCircleVsPlankSegments(t,e,n,i,o,s,r,c=!0,l=!1){const d=this.createPlankCollisionSegments(o),f=[];if(c){const S=o.modules.filter(P=>P.kind==="ladder");for(const P of S)if(P.moduleData&&P.moduleData.kind==="ladder"){const k=P.moduleData,v=P.localPos,b=k.length,M=k.width,C=k.extendDirection||Math.PI,I=u.from(Math.cos(C),Math.sin(C)),D=I.perp(),E=M/2,L=v.add(I.mul(b)),H=[v.add(D.mul(E)),v.add(D.mul(-E)),L.add(D.mul(-E)),L.add(D.mul(E))].map(et=>et.rotate(o.rotation).add(o.position));f.push(H)}}const m=f.some(S=>T.pointInPolygon(t,S,n+s)||T.pointInPolygon(e,S,n+s)),p=this.isPlayerInsideShipBounds(t,o,n+s),y=this.isPlayerInsideShipBounds(e,o,n+s);if(p&&!y&&!l&&!m){const S=this.clampPlayerToShipBounds(e,o,n+s),P=S.sub(t),k=P.length()>0?P.normalize().mul(i.length()):u.zero(),v=S.sub(e),b=v.length()>0?v.normalize():u.from(0,-1);return V.trackCollision(t,S,b,e.sub(S).length(),P.length(),!0,-1),{newPosition:S,newVelocity:k,collided:!0,normal:b,penetrationDepth:e.sub(S).length(),contactPoint:S,slideDistance:P.length()}}if(l)return{newPosition:e,newVelocity:i,collided:!1,normal:u.zero(),penetrationDepth:0,contactPoint:u.zero(),slideDistance:0};if(m&&!p&&y&&c)return{newPosition:e,newVelocity:i,collided:!1,normal:u.zero(),penetrationDepth:0,contactPoint:u.zero(),slideDistance:0};let g=null,x=1/0,w;for(const S of d){const P=S.start,k=S.end,v=T.sweptCircleVsSegment(t,e,n,P,k);if(v.hit&&v.time<x){x=v.time,w=S.plankId;const b=t.add(e.sub(t).mul(v.time)),M=i.dot(v.normal),C=i.sub(v.normal.mul(M*2));g={newPosition:b,newVelocity:C,collided:!0,normal:v.normal,penetrationDepth:0,contactPoint:v.point,slideDistance:0}}}return g?(V.trackCollision(t,g.contactPoint,g.normal,g.penetrationDepth,g.slideDistance,!0,w),g):{newPosition:e,newVelocity:i,collided:!1,normal:u.zero(),penetrationDepth:0,contactPoint:u.zero(),slideDistance:0}}static isPlayerInsideShipBounds(t,e,n){const i=this.getTransformedShipHull(e);return T.pointInPolygon(t,i,n)}static getTransformedShipHull(t){const e=t.id.toString(),n=this.hullCache.get(e);if(n&&n.position.equals(t.position)&&Math.abs(n.rotation-t.rotation)<1e-6)return n.hull;const i=t.hull.map(o=>o.rotate(t.rotation).add(t.position));return this.hullCache.set(e,{hull:i,position:t.position,rotation:t.rotation}),i}static clearHullCache(){this.hullCache.clear()}static clampPlayerToShipBounds(t,e,n){const i=this.getTransformedShipHull(e),o=T.closestPointOnPolygon(t,i),s=e.position,r=s.sub(o);if(r.length()<1e-6)return s;const c=r.normalize();return o.add(c.mul(n))}};h(V,"hullCache",new Map);let G=V;const Y=new Map;function lt(a){var r;const t=`${a.id}`,e=Date.now(),n=Y.get(t);if(n&&e-n.lastUpdate<33)return n.polygon;let i=0,o=0;for(const c of a.modules)c.kind==="plank"&&((r=c.moduleData)==null?void 0:r.kind)==="plank"&&(o++,c.moduleData.health>0&&i++);let s;return o===0?s=a.hull.slice():i===0?s=[]:i/o<.5?s=a.hull.map(l=>l.mul(.7)):s=a.hull.slice(),Y.set(t,{polygon:s,lastUpdate:e}),s}function dt(a,t,e=0){const n=lt(t);if(n.length===0)return!1;const i=a.sub(t.position).rotate(-t.rotation);return ht(i,n,e)}function ht(a,t,e=0){if(t.length<3)return!1;let n=!1;const i=a.x,o=a.y;for(let s=0,r=t.length-1;s<t.length;r=s++){const c=t[s].x,l=t[s].y,d=t[r].x,f=t[r].y;l>o!=f>o&&i<(d-c)*(o-l)/(f-l)+c&&(n=!n)}if(!n&&e>0)for(let s=0;s<t.length;s++){const r=t[s],l=t[(s+1)%t.length].sub(r),d=a.sub(r);if(l.lengthSq()<1e-10)continue;const f=Math.max(0,Math.min(1,d.dot(l)/l.lengthSq())),m=r.add(l.mul(f));if(a.sub(m).length()<=e)return!0}return n}const U={CONFIRM_IN_TICKS:2,CONFIRM_OUT_TICKS:1,SWITCH_COOLDOWN_MS:50,EPSILON_FACTOR:1.5,PENETRATION_WEIGHT:10,VELOCITY_WEIGHT:1};function ut(){return{currentCarrierId:null,candidateStates:new Map,lastSwitchTime:0,switchCooldownMs:U.SWITCH_COOLDOWN_MS,confirmInTicks:U.CONFIRM_IN_TICKS,confirmOutTicks:U.CONFIRM_OUT_TICKS}}function ft(a,t,e,n){const i=[],o={...e};o.candidateStates=new Map(e.candidateStates);const s=U.EPSILON_FACTOR*a.radius;if(o.currentCarrierId!==null&&a.velocity.length()>R.PLAYER_SPEED*.8){const l=t.find(d=>d.id===o.currentCarrierId);if(l&&a.velocity.sub(l.velocity).length()>R.PLAYER_SPEED*.6)return console.log(`Player ${a.id} swimming fast but marked on-deck - forcing exit`),o.candidateStates.delete(o.currentCarrierId),i.push({type:"leftDeck",playerId:a.id,newCarrierId:null,oldCarrierId:o.currentCarrierId,timestamp:n}),i.push({type:"carrierChanged",playerId:a.id,newCarrierId:null,oldCarrierId:o.currentCarrierId,timestamp:n}),o.currentCarrierId=null,o.lastSwitchTime=n,{newState:o,events:i}}const r=new Map;if(o.currentCarrierId!==null){const l=t.find(d=>d.id===o.currentCarrierId);if(l&&a.position.distanceTo(l.position)>400)return o.candidateStates.delete(o.currentCarrierId),i.push({type:"leftDeck",playerId:a.id,newCarrierId:null,oldCarrierId:o.currentCarrierId,timestamp:n}),i.push({type:"carrierChanged",playerId:a.id,newCarrierId:null,oldCarrierId:o.currentCarrierId,timestamp:n}),o.currentCarrierId=null,o.lastSwitchTime=n,{newState:o,events:i}}for(const l of t){if(!gt(a,l,s))continue;const d=pt(a,l,s);if(d.penetrationDepth>0){const f=o.candidateStates.get(l.id),m=f?f.confirmationTicks+1:1;r.set(l.id,{shipId:l.id,penetrationDepth:d.penetrationDepth,relativeVelocity:d.relativeVelocity,confirmationTicks:m,lastDetected:n})}}for(const[l,d]of o.candidateStates.entries())r.has(l)||(d.confirmationTicks=Math.max(0,d.confirmationTicks-1));for(const[l,d]of r.entries())o.candidateStates.set(l,d);for(const[l,d]of o.candidateStates.entries())d.confirmationTicks===0&&!r.has(l)&&o.candidateStates.delete(l);const c=yt(o,n);if(c!==o.currentCarrierId){const l=o.currentCarrierId;l!==null&&c===null&&(console.log(`Player ${a.id} fell off ship ${l}!`),i.push({type:"leftDeck",playerId:a.id,newCarrierId:c,oldCarrierId:l,timestamp:n})),c!==l&&(console.log(`Player ${a.id} carrier changed: ${l} -> ${c}`),i.push({type:"carrierChanged",playerId:a.id,newCarrierId:c,oldCarrierId:l,timestamp:n})),o.currentCarrierId=c,o.lastSwitchTime=n}return{newState:o,events:i}}function mt(a){let e=a.hull.slice();const n=a.modules.filter(o=>o.kind==="ladder");if(n.length===0)return e;const i=[...e];for(const o of n)if(o.moduleData&&o.moduleData.kind==="ladder"){const s=o.moduleData,r=o.localPos,c=s.width,l=s.length,d=s.extendDirection||Math.PI,f=u.from(Math.cos(d),Math.sin(d)),m=f.perp(),p=c/2,y=r.add(f.mul(l)),g=[r.add(m.mul(p)),r.add(m.mul(-p)),y.add(m.mul(-p)),y.add(m.mul(p))];i.push(...g)}return i}function pt(a,t,e){const i=a.position.sub(t.position).rotate(-t.rotation);if(!dt(a.position,t,e))return{penetrationDepth:0,relativeVelocity:0};const s=mt(t),r=T.distanceToPolygonEdge(i,s),c=a.velocity,l=t.velocity.add(i.perp().mul(t.angularVelocity)),d=c.sub(l).length();return{penetrationDepth:r,relativeVelocity:d}}function gt(a,t,e){const n=a.position.distanceTo(t.position),o=300+e+a.radius;return n<=o}function yt(a,t){if(t-a.lastSwitchTime<a.switchCooldownMs){const i=a.currentCarrierId?a.candidateStates.get(a.currentCarrierId):null;if(i&&i.confirmationTicks>=a.confirmInTicks)return a.currentCarrierId;if(!i||i.confirmationTicks===0)return null}const n=[];for(const i of a.candidateStates.values())i.confirmationTicks>=a.confirmInTicks&&n.push(i);if(n.length===0){const i=a.currentCarrierId?a.candidateStates.get(a.currentCarrierId):null;return i&&i.confirmationTicks>0?a.currentCarrierId:null}return n.length===1||n.sort((i,o)=>{const s=o.penetrationDepth-i.penetrationDepth;if(Math.abs(s)>.1)return s>0?1:-1;const r=i.relativeVelocity-o.relativeVelocity;return Math.abs(r)>.1?r>0?1:-1:i.shipId-o.shipId}),n[0].shipId}const F={JUMP:1,INTERACT:2,DISMOUNT:4,DESTROY_PLANK:8};function St(a,t,e){const n={tick:a.tick+1,ships:a.ships.map(r=>({...r})),players:a.players.map(r=>({...r})),cannonballs:a.cannonballs.map(r=>({...r})),timestamp:a.timestamp+e*1e3,carrierDetection:new Map(a.carrierDetection)};for(const r of n.ships)wt(r,e);const i=3,o=e/i;for(let r=0;r<i;r++){for(const c of n.ships)c.position=c.position.add(c.velocity.mul(o)),c.rotation+=c.angularVelocity*o;Ct(n.ships)}const s=[];for(const r of n.players){const c=vt(r,n.ships,n.carrierDetection,t,e,n.timestamp);s.push(...c)}return n.carrierEvents=s,n}function wt(a,t){var M;const e=a.modules.find(C=>C.kind==="helm");let n=0;e&&e.moduleData&&(n=((M=e.moduleData.currentInput)==null?void 0:M.x)||0);const i=a.velocity.length(),o=5,s=40;let r;i<o?r=.05+i/o*.1:r=.15+Math.min(i/s,1)*.35;const c=1.5,l=n*r,d=.92;a.angularVelocity+=l*c*t,a.angularVelocity*=d,a.rotation=_.wrap(a.rotation+a.angularVelocity*t);let f=0,m=0;for(const C of a.modules)if(C.kind==="mast"&&C.moduleData){const I=C.moduleData,D=I.openness||0,E=I.windEfficiency||.8,L=D/100,H=Math.pow(L,.7)*E;f+=H,m++}const p=8e3,y=300;let g=y;if(m>0){const C=f/m,I=1+(m-1)*.1,D=1+f*.25,E=C*I*D;g=y+(p-y)*Math.min(E,1.25)}const w=u.from(Math.cos(a.rotation),Math.sin(a.rotation)).mul(g),S=60,P=w.div(S);a.velocity=a.velocity.add(P.mul(t));const k=.995,v=1-i*2e-4,b=Math.max(k*v,.98);a.velocity=a.velocity.mul(b)}function vt(a,t,e,n,i,o){let s=e.get(a.id);s||(s=ut(),e.set(a.id,s));const{newState:r,events:c}=ft(a,t,s,o);e.set(a.id,r);const l=r.currentCarrierId||0;a.carrierId=l,a.onDeck=l>0;const d=t.find(f=>f.id===l);return d&&a.onDeck?xt(a,d,n,i):kt(a,t,n,i),c}function xt(a,t,e,n){const i=t.position.sub(t.velocity.mul(n)),o=_.wrap(t.rotation-t.angularVelocity*n),s=_.diff(t.rotation,o),r=a.position.sub(i);let c;if(Math.abs(s)>.1)c=r.rotate(s);else{const M=r.perp().mul(t.angularVelocity*n);c=r.add(M)}const l=t.position.add(c),f=e.movement.mul(R.PLAYER_SPEED),m=t.velocity.add(r.perp().mul(t.angularVelocity)),p=a.velocity.sub(m),y=Math.log(2)/R.ICE_DRIFT_HALF_LIFE,g=Math.exp(-y*n),x=p.mul(g),w=m.add(x),S=f.mul(n);a.velocity=w.add(S);const P=l.add(f.mul(n)),k=R.EPS_FACTOR*a.radius,v=(e.actions&F.JUMP)!==0;if(v&&l.sub(t.position).length()>120*.7){console.log(`Player ${a.id} jumping near ship edge - assisting exit`);const D=l.sub(t.position).normalize().mul(R.PLAYER_SPEED*.5*n);a.position=l.add(f.mul(n)).add(D);return}const b=G.sweptCircleVsPlankSegments(l,P,a.radius,a.velocity,t,k,n,!1,v);if(b.collided){a.position=b.newPosition,a.velocity=b.newVelocity;const M=.95;a.velocity=a.velocity.mul(M)}else a.position=P,!Pt(a.position,t)&&a.onDeck&&console.log(`Player ${a.id} fell through plank gap at position ${a.position.x.toFixed(1)}, ${a.position.y.toFixed(1)}!`)}function Pt(a,t){const e=a.sub(t.position).rotate(-t.rotation),n=10;return T.pointInPolygon(e,t.hull,n)}function kt(a,t,e,n){const i=e.movement.mul(R.PLAYER_SPEED),o=.85,s=8;a.velocity=a.velocity.mul(o).add(i.mul(n*s));const r=10,l=u.from(.3,.1).normalize().mul(r*n);a.velocity=a.velocity.add(l);let f=a.position.add(a.velocity.mul(n)),m=a.velocity;for(const y of t){const g=R.EPS_FACTOR*a.radius;if(a.position.distanceTo(y.position)>400)continue;const S=G.sweptCircleVsPlankSegments(a.position,f,a.radius,m,y,g,n,!0,!1);if(S.collided){f=S.newPosition,m=S.newVelocity;break}}a.position=f,a.velocity=m;const p=R.PLAYER_SPEED*.7;a.velocity.lengthSq()>p*p&&(a.velocity=a.velocity.normalize().mul(p))}function j(a){const t=q(a);let e;if(t&&t.moduleData){const i=t.moduleData;e=i.area&&Array.isArray(i.area)?i.area:a.hull}else e=a.hull;let n=0;for(const i of e){const o=i.length();n=Math.max(n,o)}return n+10}function Ct(a){for(let t=0;t<a.length;t++)for(let e=t+1;e<a.length;e++){const n=a[t],i=a[e],o=n.position.sub(i.position).length(),s=j(n),r=j(i),c=s+r;if(o<c){const l=bt(n,i);l.isColliding&&(It(n,i,l),Tt(n,i,l))}}}function bt(a,t){const e=q(a),n=q(t);if(!e||!n)return Mt(a,t);const i=e.moduleData,o=n.moduleData,s=i&&i.area&&Array.isArray(i.area)?i.area:a.hull,r=o&&o.area&&Array.isArray(o.area)?o.area:t.hull,c=s.map(d=>d.rotate(a.rotation).add(a.position)),l=r.map(d=>d.rotate(t.rotation).add(t.position));return tt(c,l,a.position,t.position)}function q(a){return a.modules.find(t=>t.kind==="deck")}function Mt(a,t){const e=a.hull.map(i=>i.rotate(a.rotation).add(a.position)),n=t.hull.map(i=>i.rotate(t.rotation).add(t.position));return tt(e,n,a.position,t.position)}function tt(a,t,e,n){const i=[];for(let c=0;c<a.length;c++){const l=a[c],f=a[(c+1)%a.length].sub(l);i.push(u.from(-f.y,f.x).normalize())}for(let c=0;c<t.length;c++){const l=t[c],f=t[(c+1)%t.length].sub(l);i.push(u.from(-f.y,f.x).normalize())}let o=1/0,s=u.zero();for(const c of i){const l=Q(a,c),d=Q(t,c),f=Math.min(l.max,d.max)-Math.max(l.min,d.min);if(f<=0)return{isColliding:!1,normal:u.zero(),penetration:0,contactPoint:u.zero()};f<o&&(o=f,s=c)}return n.sub(e).dot(s)<0&&(s=s.mul(-1)),{isColliding:!0,normal:s,penetration:o,contactPoint:e.add(n).mul(.5)}}function Q(a,t){let e=1/0,n=-1/0;for(const i of a){const o=i.dot(t);e=Math.min(e,o),n=Math.max(n,o)}return{min:e,max:n}}function It(a,t,e){const n=e.normal,i=e.penetration,o=1e3,s=1e3,r=o+s,c=s/r,l=o/r;a.position=a.position.sub(n.mul(i*c)),t.position=t.position.add(n.mul(i*l));const f=t.velocity.sub(a.velocity).dot(n);if(f>0)return;const p=-(1+.05)*f/r,y=n.mul(p),g=y.mul(s),x=y.mul(o);a.velocity=a.velocity.sub(g),t.velocity=t.velocity.add(x);const w=Math.abs(f),S=e.contactPoint.sub(a.position),P=e.contactPoint.sub(t.position),k=Math.min(w*5e-4,.002),v=S.cross(g.mul(-1))*k,b=P.cross(x)*k;a.angularVelocity+=v,t.angularVelocity+=b;const M=Math.max(.7,1-w*.01),C=Math.max(.6,1-w*.015);a.velocity=a.velocity.mul(M),t.velocity=t.velocity.mul(M),a.angularVelocity*=C,t.angularVelocity*=C}function Tt(a,t,e){const n=e.penetration*10,i=50,o=Math.min(n*2,15);X(a,e.contactPoint,o,i),X(t,e.contactPoint,o,i)}function X(a,t,e,n){for(const i of a.modules){if(i.kind!=="plank"||!i.moduleData||i.moduleData.kind!=="plank")continue;const o=i.moduleData;if(o.health<=0)continue;const r=i.localPos.rotate(a.rotation).add(a.position).sub(t).length();if(r<=n){const c=1-r/n,l=e*c;o.health=Math.max(0,o.health-l),o.health<=0&&l>0?(console.log(`💥 Collision destroyed plank! (${l.toFixed(1)} damage)`),o.destroyed=!0):l>0&&console.log(`⚔️ Collision damaged plank: ${o.health.toFixed(1)} health remaining`)}}}class Dt{constructor(t){h(this,"config");h(this,"predictionHistory",[]);h(this,"authoritativeState",null);h(this,"lastAuthoritativeTick",0);h(this,"clientTick",0);h(this,"needsRollback",!1);h(this,"rollbackTick",0);this.config=t}update(t,e,n){if(this.clientTick++,this.storePredictionState(this.clientTick,t,e),!this.config.enablePrediction)return t;const i=this.simulateStep(t,e,n);return this.needsRollback?this.performRollback(i,n):i}onAuthoritativeState(t){this.authoritativeState=t,this.lastAuthoritativeTick=t.tick;const e=this.findPredictionState(t.tick);e&&this.statesDiffer(t,e.worldState)&&(console.log(`🔄 Server correction detected at tick ${t.tick}`),this.scheduleRollback(t.tick)),this.cleanupOldStates(t.tick)}getInterpolatedState(t){return!this.config.enableInterpolation||!this.authoritativeState?this.authoritativeState:this.authoritativeState}isPredictionEnabled(){return this.config.enablePrediction}getPredictionStats(){return{clientTick:this.clientTick,authoritativeTick:this.lastAuthoritativeTick,predictionHistory:this.predictionHistory.length,rollbacksPerformed:0}}simulateStep(t,e,n){return St(t,e,n)}storePredictionState(t,e,n){const i={tick:t,worldState:this.cloneWorldState(e),inputFrame:{...n},timestamp:Date.now()};this.predictionHistory.push(i);const o=this.config.rollbackLimit+10;this.predictionHistory.length>o&&this.predictionHistory.shift()}findPredictionState(t){return this.predictionHistory.find(e=>e.tick===t)||null}statesDiffer(t,e){if(t.players.length!==e.players.length)return!0;for(let n=0;n<t.players.length;n++){const i=t.players[n],o=e.players[n];if(!i||!o)return!0;const s=i.position.sub(o.position).length();if(s>1)return console.log(`Player ${i.id} position diff: ${s}`),!0;if(i.onDeck!==o.onDeck||i.carrierId!==o.carrierId)return!0}if(t.ships.length!==e.ships.length)return!0;for(let n=0;n<t.ships.length;n++){const i=t.ships[n],o=e.ships[n];if(!i||!o||i.position.sub(o.position).length()>2)return!0}return!1}scheduleRollback(t){this.needsRollback=!0,this.rollbackTick=t}performRollback(t,e){if(!this.authoritativeState)return this.needsRollback=!1,t;console.log(`🎬 Performing rollback from tick ${this.rollbackTick}`);let n=this.cloneWorldState(this.authoritativeState);const i=this.predictionHistory.filter(o=>o.tick>this.rollbackTick&&o.tick<=this.clientTick);for(const o of i)n=this.simulateStep(n,o.inputFrame,e);return this.updatePredictionHistory(i,n),this.needsRollback=!1,n}updatePredictionHistory(t,e){if(t.length>0){const n=t[t.length-1];n.worldState=this.cloneWorldState(e)}}cleanupOldStates(t){const e=t-this.config.rollbackLimit;this.predictionHistory=this.predictionHistory.filter(n=>n.tick>=e)}cloneWorldState(t){return{tick:t.tick,timestamp:t.timestamp,ships:t.ships.map(e=>({...e,position:e.position.clone(),velocity:e.velocity.clone(),hull:e.hull.map(n=>n.clone()),modules:e.modules.map(n=>({...n}))})),players:t.players.map(e=>({...e,position:e.position.clone(),velocity:e.velocity.clone()})),cannonballs:t.cannonballs.map(e=>({...e,position:e.position.clone(),velocity:e.velocity.clone(),firingVelocity:e.firingVelocity.clone(),smokeTrail:e.smokeTrail?e.smokeTrail.map(n=>({...n,position:n.position.clone()})):[]})),carrierDetection:new Map(t.carrierDetection)}}}class Et{constructor(t,e){h(this,"canvas");h(this,"config");h(this,"inputState");h(this,"actionMappings",[]);h(this,"currentInputFrame");h(this,"inputFrameCounter",0);h(this,"onInputFrame",null);h(this,"lastInteractionTime",0);h(this,"interactionCooldown",500);this.canvas=t,this.config=e,this.inputState={pressedKeys:new Set,mousePosition:u.from(t.width/2,t.height/2),mouseWorldPosition:u.zero(),leftMouseDown:!1,rightMouseDown:!1,leftMouseReleased:!1,gamepadConnected:!1,gamepadState:null},this.currentInputFrame={tick:0,movement:u.zero(),actions:0},this.setupEventListeners(),this.setupActionMappings()}update(t){this.updateGamepad(),this.generateInputFrame(),this.onInputFrame&&this.onInputFrame(this.currentInputFrame),this.resetFrameFlags()}updateMouseWorldPosition(t){this.inputState.mouseWorldPosition=t.clone()}getCurrentInputFrame(){return{...this.currentInputFrame}}getMouseWorldPosition(){return this.inputState.mouseWorldPosition.clone()}isActionActive(t){const e=this.actionMappings.find(n=>n.action===t);return e?e.pressed:!1}updateConfig(t){this.config={...t},this.setupActionMappings(),console.log("🎮 Input configuration updated")}shutdown(){this.removeEventListeners(),console.log("🎮 Input manager shutdown")}setupEventListeners(){window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this)),this.canvas.addEventListener("mousemove",this.onMouseMove.bind(this)),this.canvas.addEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.addEventListener("wheel",this.onMouseWheel.bind(this)),this.canvas.addEventListener("contextmenu",this.onContextMenu.bind(this)),window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this)),console.log("🎮 Input event listeners setup")}removeEventListeners(){window.removeEventListener("keydown",this.onKeyDown.bind(this)),window.removeEventListener("keyup",this.onKeyUp.bind(this)),this.canvas.removeEventListener("mousemove",this.onMouseMove.bind(this)),this.canvas.removeEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.removeEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.removeEventListener("wheel",this.onMouseWheel.bind(this)),this.canvas.removeEventListener("contextmenu",this.onContextMenu.bind(this)),window.removeEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.removeEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this))}setupActionMappings(){this.actionMappings=[];for(const[t,e]of this.config.keyBindings.entries())this.actionMappings.push({action:t,keyCode:e,pressed:!1})}generateInputFrame(){const t=this.calculateMovementVector(),e=this.calculateActionBitmask();this.currentInputFrame={tick:this.inputFrameCounter++,movement:t,actions:e}}calculateMovementVector(){let t=u.zero();const e=this.isActionActive("move_forward"),n=this.isActionActive("move_backward"),i=this.isActionActive("move_left"),o=this.isActionActive("move_right");return e&&(t=t.add(u.from(0,-1))),n&&(t=t.add(u.from(0,1))),i&&(t=t.add(u.from(-1,0))),o&&(t=t.add(u.from(1,0))),t.lengthSq()>1&&(t=t.normalize()),t}calculateActionBitmask(){let t=0;return this.isActionActive("jump")&&(t|=F.JUMP),this.isActionActive("interact")&&this.canInteract()&&(t|=F.INTERACT,this.lastInteractionTime=Date.now()),this.isActionActive("dismount")&&this.canInteract()&&(t|=F.DISMOUNT,this.lastInteractionTime=Date.now()),this.isActionActive("destroy_plank")&&(t|=F.DESTROY_PLANK),t}canInteract(){return Date.now()-this.lastInteractionTime>this.interactionCooldown}resetFrameFlags(){this.inputState.leftMouseReleased=!1}updateGamepad(){if(!this.config.gamepadEnabled||!this.inputState.gamepadConnected)return;const e=navigator.getGamepads()[0];if(!e){this.inputState.gamepadConnected=!1;return}this.inputState.gamepadState={axes:Array.from(e.axes),buttons:e.buttons.map(n=>n.pressed)}}onKeyDown(t){this.inputState.pressedKeys.add(t.code);for(const e of this.actionMappings)e.keyCode===t.code&&(e.pressed=!0);switch(t.code){}}onKeyUp(t){this.inputState.pressedKeys.delete(t.code);for(const e of this.actionMappings)e.keyCode===t.code&&(e.pressed=!1)}onMouseMove(t){const e=this.canvas.getBoundingClientRect();this.inputState.mousePosition=u.from(t.clientX-e.left,t.clientY-e.top)}onMouseDown(t){t.preventDefault(),t.button===0?this.inputState.leftMouseDown=!0:t.button===2&&(this.inputState.rightMouseDown=!0)}onMouseUp(t){t.preventDefault(),t.button===0?(this.inputState.leftMouseDown=!1,this.inputState.leftMouseReleased=!0):t.button===2&&(this.inputState.rightMouseDown=!1)}onMouseWheel(t){t.preventDefault()}onContextMenu(t){t.preventDefault()}onGamepadConnected(t){console.log("🎮 Gamepad connected:",t.gamepad.id),this.inputState.gamepadConnected=!0}onGamepadDisconnected(t){console.log("🎮 Gamepad disconnected:",t.gamepad.id),this.inputState.gamepadConnected=!1,this.inputState.gamepadState=null}}const J={helm:u.from(0,-15),"steering-wheel":u.from(0,-15),cannon:u.from(0,-20),mast:u.from(0,15),seat:u.from(0,0),ladder:u.from(0,-10),custom:u.zero()},Z={helm:30,"steering-wheel":30,cannon:25,mast:35,seat:20,ladder:25,custom:20};class Rt{constructor(){h(this,"mountedPlayers",new Map);h(this,"lastInteractionResults",[])}update(t,e){this.updateMountedPlayerPositions(t),this.lastInteractionResults=[],this.updateModuleSystems(t,e)}interactWithModule(t,e,n){const i=t.players.find(l=>l.id===e),{ship:o,module:s}=this.findModule(t,n),r=this.validateInteraction(i,o,s);return r.result!=="success"?r:this.mountedPlayers.get(e)!==void 0?this.dismountPlayer(t,e):this.isModuleOccupied(n)?{playerId:e,moduleId:n,result:"failed_occupied",message:"Module is already occupied"}:this.mountPlayer(t,e,n,i,o,s)}dismountPlayer(t,e){const n=this.mountedPlayers.get(e);if(n===void 0)return{playerId:e,moduleId:-1,result:"failed_invalid_module",message:"Player is not mounted to any module"};this.mountedPlayers.delete(e),t.players.find(o=>o.id===e);const i={playerId:e,moduleId:n,result:"success",message:"Dismounted successfully"};return this.lastInteractionResults.push(i),i}getNearbyInteractableModules(t,e){const n=t.players.find(s=>s.id===e);if(!n||!n.onDeck)return[];const i=t.ships.find(s=>s.id===n.carrierId);if(!i)return[];const o=[];for(const s of i.modules){if(s.kind==="deck")continue;const r=this.getModuleWorldPosition(i,s),c=n.position.sub(r).length(),l=Z[s.kind]||20;c<=l&&o.push(s)}return o}isPlayerMounted(t){return this.mountedPlayers.has(t)}getPlayerMountedModule(t,e){const n=this.mountedPlayers.get(e);if(n===void 0)return null;const{module:i}=this.findModule(t,n);return i}getLastInteractionResults(){return[...this.lastInteractionResults]}validateInteraction(t,e,n){if(!t)return{playerId:0,moduleId:-1,result:"failed_invalid_module",message:"Player not found"};if(!t.onDeck)return{playerId:t.id,moduleId:-1,result:"failed_not_on_deck",message:"Must be on deck to interact with modules"};if(!e||!n)return{playerId:t.id,moduleId:-1,result:"failed_invalid_module",message:"Module not found"};const i=this.getModuleWorldPosition(e,n),o=t.position.sub(i).length(),s=Z[n.kind]||20;return o>s?{playerId:t.id,moduleId:n.id,result:"failed_out_of_range",message:`Too far from module (${o.toFixed(1)} > ${s})`}:{playerId:t.id,moduleId:n.id,result:"success"}}mountPlayer(t,e,n,i,o,s){this.mountedPlayers.set(e,n);const r=this.getModuleWorldPosition(o,s),c=J[s.kind]||u.zero(),l=r.add(c.rotate(o.rotation));i.position=l,i.velocity=u.zero();const d={playerId:e,moduleId:n,result:"success",message:`Mounted to ${s.kind} module`};return this.lastInteractionResults.push(d),d}findModule(t,e){for(const n of t.ships){const i=n.modules.find(o=>o.id===e);if(i)return{ship:n,module:i}}return{ship:null,module:null}}getModuleWorldPosition(t,e){return e.localPos.rotate(t.rotation).add(t.position)}isModuleOccupied(t){for(const[,e]of this.mountedPlayers)if(e===t)return!0;return!1}updateMountedPlayerPositions(t){for(const[e,n]of this.mountedPlayers){const i=t.players.find(r=>r.id===e),{ship:o,module:s}=this.findModule(t,n);if(i&&o&&s){const r=this.getModuleWorldPosition(o,s),c=J[s.kind]||u.zero(),l=r.add(c.rotate(o.rotation));i.position=l,i.velocity=u.zero()}}}updateModuleSystems(t,e){for(const n of t.ships)for(const i of n.modules)switch(i.kind){case"cannon":this.updateCannonModule(i,e);break;case"mast":this.updateMastModule(i,e);break}}updateCannonModule(t,e){if(!t.moduleData||t.moduleData.kind!=="cannon")return;const n=t.moduleData;n.timeSinceLastFire!==void 0&&n.reloadTime!==void 0&&n.timeSinceLastFire<n.reloadTime&&(n.timeSinceLastFire+=e)}updateMastModule(t,e){!t.moduleData||t.moduleData.kind!=="mast"||t.moduleData}}class At{constructor(t,e){h(this,"config");h(this,"elements",new Map);h(this,"showDebugOverlay",!1);h(this,"showNetworkStats",!1);h(this,"showControlHints",!0);this.config=e,this.initializeUIElements(),this.setupEventListeners()}update(t){this.showDebugOverlay=this.config.debug.enabled,this.showNetworkStats=this.config.debug.showNetworkStats}render(t,e){const n=["hud","control_hints","network_stats","debug_overlay"];for(const i of n){const o=this.elements.get(i);if(o&&o.visible)try{o.render(t,e)}catch(s){console.error(`Error rendering UI element ${i}:`,s)}}}toggleDebugOverlay(){this.showDebugOverlay=!this.showDebugOverlay;const t=this.elements.get("debug_overlay");t&&(t.visible=this.showDebugOverlay)}toggleNetworkStats(){this.showNetworkStats=!this.showNetworkStats;const t=this.elements.get("network_stats");t&&(t.visible=this.showNetworkStats)}onCanvasResize(t,e){console.log(`📱 UI canvas resized to ${t}x${e}`)}shutdown(){this.removeEventListeners(),console.log("🖥️ UI manager shutdown")}initializeUIElements(){this.elements.set("hud",new zt),this.elements.set("debug_overlay",new Lt),this.elements.set("network_stats",new Nt),this.elements.set("control_hints",new Ot),this.updateElementVisibility()}updateElementVisibility(){this.elements.get("hud").visible=!0,this.elements.get("debug_overlay").visible=this.showDebugOverlay,this.elements.get("network_stats").visible=this.showNetworkStats,this.elements.get("control_hints").visible=this.showControlHints}setupEventListeners(){window.addEventListener("keydown",this.onKeyDown.bind(this))}removeEventListeners(){window.removeEventListener("keydown",this.onKeyDown.bind(this))}onKeyDown(t){switch(t.code){case"KeyL":this.toggleDebugOverlay();break;case"F1":this.showControlHints=!this.showControlHints,this.updateElementVisibility();break}}}class zt{constructor(){h(this,"type","hud");h(this,"visible",!0)}render(t,e){const n=e.worldState.players[0];if(!n)return;t.fillStyle="#ffffff",t.font="16px Arial",t.textAlign="left",[`FPS: ${e.fps}`,`Position: ${n.position.x.toFixed(1)}, ${n.position.y.toFixed(1)}`,`On Deck: ${n.onDeck?"Yes":"No"}`,`Carrier: ${n.carrierId}`].forEach((o,s)=>{t.fillText(o,20,30+s*20)})}}class Lt{constructor(){h(this,"type","debug_overlay");h(this,"visible",!1)}render(t,e){const n=e.worldState.players[0],i=e.camera.getState();if(!n)return;t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(10,10,400,300),t.fillStyle="#00ff00",t.font="14px monospace",t.textAlign="left",["=== DEBUG INFO ===",`Tick: ${e.worldState.tick}`,`Player Velocity: ${n.velocity.x.toFixed(2)}, ${n.velocity.y.toFixed(2)}`,`Camera Position: ${i.position.x.toFixed(1)}, ${i.position.y.toFixed(1)}`,`Camera Zoom: ${i.zoom.toFixed(2)}x`,`Ships: ${e.worldState.ships.length}`,`Cannonballs: ${e.worldState.cannonballs.length}`,"","=== CONTROLS ===","L - Toggle this overlay","F1 - Toggle control hints","WASD - Movement","Space - Jump off ship","E - Interact with modules"].forEach((s,r)=>{t.fillText(s,20,35+r*16)})}}class Nt{constructor(){h(this,"type","network_stats");h(this,"visible",!1)}render(t,e){const n=e.networkStats;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(t.canvas.width-220,10,210,120),t.fillStyle="#00ffff",t.font="14px monospace",t.textAlign="left",["=== NETWORK ===",`Ping: ${n.ping}ms`,`Packet Loss: ${n.packetLoss.toFixed(1)}%`,`Sent: ${(n.bytesSent/1024).toFixed(1)}KB`,`Received: ${(n.bytesReceived/1024).toFixed(1)}KB`,`Messages: ${n.messagesSent}/${n.messagesReceived}`].forEach((o,s)=>{t.fillText(o,t.canvas.width-210,30+s*16)})}}class Ot{constructor(){h(this,"type","control_hints");h(this,"visible",!0)}render(t,e){t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(10,t.canvas.height-120,300,110),t.fillStyle="#ffff00",t.font="12px Arial",t.textAlign="left",["CONTROLS:","WASD - Move","Mouse - Look direction","Space - Jump off ship","E - Interact with modules","R - Dismount from modules","Q - Damage planks"].forEach((i,o)=>{t.fillText(i,20,t.canvas.height-105+o*14)})}}const N={CANNON_FIRE:"cannon_fire",WATER_SPLASH:"water_splash",WOOD_BREAK:"wood_break",SAIL_FLAP:"sail_flap",ROPE_CREAK:"rope_creak",FOOTSTEPS_WOOD:"footsteps_wood",MODULE_INTERACT:"module_interact"},B={MAIN_THEME:"main_theme",BATTLE_MUSIC:"battle_music",AMBIENT_OCEAN:"ambient_ocean"};class _t{constructor(t){h(this,"config");h(this,"audioContext",null);h(this,"masterGain",null);h(this,"musicGain",null);h(this,"sfxGain",null);h(this,"voiceGain",null);h(this,"sources",new Map);h(this,"loadedBuffers",new Map);h(this,"listenerPosition",u.zero());this.config=t}async initialize(){if(!this.config.enabled){console.log("🔇 Audio disabled by configuration");return}try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.connect(this.audioContext.destination),this.masterGain.gain.value=this.config.masterVolume,this.setupVolumeNodes(),await this.loadAudioAssets(),console.log("🔊 Audio system initialized")}catch(t){console.error("❌ Failed to initialize audio system:",t)}}update(t){!this.audioContext||!this.config.enabled||(this.updateSpatialAudio(),this.cleanupFinishedSources())}playSFX(t,e,n=1){if(!this.canPlayAudio())return"";const i=this.loadedBuffers.get(t);if(!i)return console.warn(`Sound effect not found: ${t}`),"";const o=`sfx_${t}_${Date.now()}_${Math.random()}`,s={id:o,type:"sfx",buffer:i,source:null,gainNode:null,position:e==null?void 0:e.clone(),loop:!1,playing:!1};return this.playAudioSource(s,n),this.sources.set(o,s),o}playMusic(t,e=!0,n=1){if(!this.canPlayAudio())return"";this.stopAllMusic();const i=this.loadedBuffers.get(t);if(!i)return console.warn(`Music track not found: ${t}`),"";const o=`music_${t}`,s={id:o,type:"music",buffer:i,source:null,gainNode:null,loop:e,playing:!1};return this.playAudioSource(s,n),this.sources.set(o,s),o}stopAudio(t){const e=this.sources.get(t);!e||!e.source||(e.source.stop(),e.playing=!1)}stopAllMusic(){for(const[t,e]of this.sources)e.type==="music"&&e.playing&&this.stopAudio(t)}setListenerPosition(t){this.listenerPosition=t.clone()}updateConfig(t){this.config={...t},this.canPlayAudio()&&(this.masterGain.gain.value=t.masterVolume,this.musicGain.gain.value=t.musicVolume,this.sfxGain.gain.value=t.sfxVolume,this.voiceGain.gain.value=t.voiceVolume,console.log("🔊 Audio configuration updated"))}shutdown(){for(const[t,e]of this.sources)e.playing&&this.stopAudio(t);this.audioContext&&this.audioContext.state!=="closed"&&this.audioContext.close(),this.sources.clear(),this.loadedBuffers.clear(),console.log("🔇 Audio system shutdown")}canPlayAudio(){return this.config.enabled&&this.audioContext!==null&&this.masterGain!==null}setupVolumeNodes(){!this.audioContext||!this.masterGain||(this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.masterGain),this.musicGain.gain.value=this.config.musicVolume,this.sfxGain=this.audioContext.createGain(),this.sfxGain.connect(this.masterGain),this.sfxGain.gain.value=this.config.sfxVolume,this.voiceGain=this.audioContext.createGain(),this.voiceGain.connect(this.masterGain),this.voiceGain.gain.value=this.config.voiceVolume)}async loadAudioAssets(){const t=[{id:N.CANNON_FIRE,duration:1},{id:N.WATER_SPLASH,duration:.5},{id:N.WOOD_BREAK,duration:.3},{id:N.SAIL_FLAP,duration:.8},{id:N.ROPE_CREAK,duration:1.2},{id:N.FOOTSTEPS_WOOD,duration:.2},{id:N.MODULE_INTERACT,duration:.1},{id:B.MAIN_THEME,duration:120},{id:B.BATTLE_MUSIC,duration:180},{id:B.AMBIENT_OCEAN,duration:300}];for(const e of t){const n=await this.createSampleBuffer(e.id,e.duration);n&&this.loadedBuffers.set(e.id,n)}console.log(`🎵 Loaded ${this.loadedBuffers.size} audio assets`)}async createSampleBuffer(t,e){if(!this.audioContext)return null;const n=this.audioContext.sampleRate,i=n*e,o=this.audioContext.createBuffer(2,i,n);for(let s=0;s<o.numberOfChannels;s++){const r=o.getChannelData(s);for(let c=0;c<i;c++){let l=0;if(t.includes("cannon")||t.includes("explosion"))l=(Math.random()*2-1)*Math.exp(-c/(i*.3))*.5;else if(t.includes("water")||t.includes("splash"))l=(Math.random()*2-1)*Math.exp(-c/(i*.5))*.3;else if(t.includes("music")||t.includes("theme")){const d=440*Math.pow(2,Math.sin(c/i*Math.PI*4)*.5);l=Math.sin(2*Math.PI*d*c/n)*.1}else l=Math.sin(2*Math.PI*440*c/n)*.2;r[c]=l}}return o}playAudioSource(t,e){if(!this.audioContext||!t.buffer)return;const n=this.audioContext.createBufferSource(),i=this.audioContext.createGain();n.buffer=t.buffer,n.loop=t.loop,i.gain.value=e;let o;switch(t.type){case"music":o=this.musicGain;break;case"sfx":o=this.sfxGain;break;case"voice":o=this.voiceGain;break;default:o=this.sfxGain;break}n.connect(i),i.connect(o),t.position&&this.config.spatialAudio&&this.applySpatialAudio(i,t.position),t.source=n,t.gainNode=i,t.playing=!0,n.onended=()=>{t.playing=!1},n.start()}applySpatialAudio(t,e){if(!this.audioContext)return;const n=this.listenerPosition.sub(e).length(),o=Math.max(0,1-n/500);t.gain.value*=o}updateSpatialAudio(){if(this.config.spatialAudio)for(const t of this.sources.values())t.playing&&t.position&&t.gainNode&&this.applySpatialAudio(t.gainNode,t.position)}cleanupFinishedSources(){var t;for(const[e,n]of this.sources)!n.playing&&n.source&&(n.source.disconnect(),(t=n.gainNode)==null||t.disconnect(),this.sources.delete(e))}}var O=(a=>(a.INITIALIZING="initializing",a.CONNECTING="connecting",a.CONNECTED="connected",a.IN_GAME="in_game",a.DISCONNECTED="disconnected",a.ERROR="error",a))(O||{});class Wt{constructor(t,e){h(this,"canvas");h(this,"config");h(this,"state","initializing");h(this,"renderSystem");h(this,"networkManager");h(this,"predictionEngine");h(this,"inputManager");h(this,"uiManager");h(this,"audioManager");h(this,"moduleInteractionSystem");h(this,"authoritativeWorldState",null);h(this,"predictedWorldState",null);h(this,"demoWorldState",null);h(this,"camera");h(this,"running",!1);h(this,"lastFrameTime",0);h(this,"accumulator",0);h(this,"clientTickDuration");h(this,"frameCount",0);h(this,"fpsTimer",0);h(this,"currentFPS",0);this.canvas=t,this.config=e,this.clientTickDuration=1e3/e.prediction.clientTickRate,console.log(`🎮 Client initialized with ${e.prediction.clientTickRate}Hz tick rate`)}async initialize(){try{this.state="initializing",console.log("⚡ Initializing client systems..."),this.camera=new rt({width:this.canvas.width,height:this.canvas.height},{position:u.from(600,400),zoom:1,rotation:0}),this.renderSystem=new at(this.canvas,this.config.graphics),await this.renderSystem.initialize(),this.networkManager=new ct(this.config.network),this.networkManager.setWorldStateHandler(this.onServerWorldState.bind(this)),this.networkManager.setConnectionStateHandler(this.onConnectionStateChanged.bind(this)),this.predictionEngine=new Dt(this.config.prediction),this.inputManager=new Et(this.canvas,this.config.input),this.inputManager.onInputFrame=this.onInputFrame.bind(this),this.uiManager=new At(this.canvas,this.config),this.audioManager=new _t(this.config.audio),await this.audioManager.initialize(),this.moduleInteractionSystem=new Rt,this.setupCanvasResizeHandler(),console.log("✅ All client systems initialized successfully")}catch(t){throw this.state="error",console.error("❌ Failed to initialize client systems:",t),t}}async start(){if(this.running){console.warn("⚠️ Client is already running");return}try{console.log("🚀 Starting client application..."),this.state="connecting";try{await this.networkManager.connect("Player"),console.log("✅ Connected to physics server")}catch(t){console.warn("⚠️ Could not connect to physics server:",t),console.log("🎮 Running in offline mode - UI and local systems will work"),this.state="disconnected",this.createDemoWorldState()}this.running=!0,this.lastFrameTime=performance.now(),requestAnimationFrame(this.gameLoop.bind(this)),console.log("✅ Client application started successfully")}catch(t){throw this.state="error",console.error("❌ Failed to start client application:",t),t}}shutdown(){var t,e,n,i,o;console.log("🛑 Shutting down client application..."),this.running=!1,this.state="disconnected",(t=this.networkManager)==null||t.disconnect(),(e=this.audioManager)==null||e.shutdown(),(n=this.inputManager)==null||n.shutdown(),(i=this.uiManager)==null||i.shutdown(),(o=this.renderSystem)==null||o.shutdown(),console.log("✅ Client application shutdown complete")}gameLoop(t){if(!this.running)return;const e=t-this.lastFrameTime;this.lastFrameTime=t;const n=Math.min(e,100);for(this.accumulator+=n,this.updateFPSTracking(e);this.accumulator>=this.clientTickDuration;)this.updateClient(this.clientTickDuration),this.accumulator-=this.clientTickDuration;this.updateVariableTimestep(n);const i=this.accumulator/this.clientTickDuration;this.renderFrame(i),requestAnimationFrame(this.gameLoop.bind(this))}updateClient(t){const e=t/1e3;this.inputManager.update(e),this.authoritativeWorldState&&this.state==="in_game"&&(this.predictedWorldState=this.predictionEngine.update(this.authoritativeWorldState,this.inputManager.getCurrentInputFrame(),e),this.predictedWorldState&&this.updateCamera(this.predictedWorldState,e),this.moduleInteractionSystem.update(this.predictedWorldState||this.authoritativeWorldState,e))}updateVariableTimestep(t){const e=t/1e3;this.uiManager.update(e),this.audioManager.update(e),this.renderSystem.update(e)}renderFrame(t){const e=this.predictedWorldState||this.authoritativeWorldState||this.demoWorldState;e?(this.renderSystem.renderWorld(e,this.camera,t),this.uiManager.render(this.renderSystem.getContext(),{worldState:e,camera:this.camera,fps:this.currentFPS,networkStats:this.networkManager.getStats(),config:this.config})):this.renderSystem.renderLoadingScreen(this.state,this.camera)}updateCamera(t,e){const n=t.players[0];if(!n)return;const i=5;this.camera.setTarget(n.position),this.camera.followTarget(n.position,i,e)}onInputFrame(t){this.networkManager.sendInput(t)}onServerWorldState(t){this.authoritativeWorldState=t,this.predictionEngine.onAuthoritativeState(t),this.state==="connected"&&(this.state="in_game",console.log("🎮 Entered game world"))}onConnectionStateChanged(t){t===W.CONNECTED?(this.state="connected",console.log("🌐 Connected to server")):t===W.DISCONNECTED||t===W.ERROR?(this.state="disconnected",console.log("🔌 Disconnected from server:",t)):t===W.CONNECTING&&(this.state="connecting",console.log("🔄 Connecting to server..."))}setupCanvasResizeHandler(){new ResizeObserver(e=>{for(const n of e){const{width:i,height:o}=n.contentRect;this.canvas.width=i,this.canvas.height=o,this.camera.setViewport({width:i,height:o}),this.renderSystem.onCanvasResize(i,o),this.uiManager.onCanvasResize(i,o)}}).observe(this.canvas)}updateFPSTracking(t){this.frameCount++,this.fpsTimer+=t,this.fpsTimer>=1e3&&(this.currentFPS=Math.round(this.frameCount*1e3/this.fpsTimer),this.frameCount=0,this.fpsTimer=0)}getState(){return this.state}getConfig(){return this.config}updateConfig(t){this.config={...this.config,...t},this.renderSystem.updateConfig(this.config.graphics),this.audioManager.updateConfig(this.config.audio),this.inputManager.updateConfig(this.config.input),console.log("⚙️ Client configuration updated")}createDemoWorldState(){return{players:[{id:"demo-player",position:{x:0,y:0},velocity:{x:0,y:0},rotation:0,health:100,ship:{modules:[{type:"core",position:{x:0,y:0}},{type:"cannon",position:{x:-1,y:0}},{type:"cannon",position:{x:1,y:0}}]}}],projectiles:[],particles:[],tick:0}}}const $={network:{serverUrl:"ws://192.168.56.10:8080",maxReconnectAttempts:5,reconnectDelay:2e3,heartbeatInterval:3e4,timeoutDuration:1e4,protocol:"websocket",fallbackToWebSocket:!0},graphics:{targetFPS:60,vsync:!0,antialiasing:!0,particleQuality:"medium",shadowQuality:"medium",textureQuality:"high",renderDistance:2e3},audio:{masterVolume:1,musicVolume:.7,sfxVolume:.8,voiceVolume:1,enabled:!0,spatialAudio:!0},input:{mouseSensitivity:1,invertMouseY:!1,keyBindings:new Map([["move_forward","KeyW"],["move_backward","KeyS"],["move_left","KeyA"],["move_right","KeyD"],["jump","Space"],["interact","KeyE"],["dismount","KeyR"],["destroy_plank","KeyQ"],["toggle_debug","KeyL"],["toggle_plank_bounds","KeyP"],["toggle_collision_tracker","KeyT"],["toggle_water_mode","KeyN"],["toggle_camera_mode","KeyC"]]),gamepadEnabled:!0,gamepadDeadzone:.1},prediction:{clientTickRate:120,serverTickRate:30,interpolationBuffer:100,extrapolationLimit:50,rollbackLimit:10,enablePrediction:!0,enableInterpolation:!0},debug:{enabled:!1,showNetworkStats:!1,showPerformanceStats:!1,showCollisionBounds:!1,showPlankBounds:!1,showCarrierDetection:!1,logLevel:"info",recordReplays:!1,maxReplayLength:300},canvas:{width:1920,height:1080}};async function K(){try{let a=function(){t.width=window.innerWidth,t.height=window.innerHeight};console.log("🏴‍☠️ Pirate MMO Client Starting...");const t=document.getElementById("gameCanvas");if(!t)throw new Error("Canvas element #gameCanvas not found");a(),window.addEventListener("resize",a);const e={...$,...Ft(),canvas:{width:t.width,height:t.height}},n=new Wt(t,e);await n.initialize(),n.start(),console.log("✅ Pirate MMO Client Started Successfully"),window.addEventListener("beforeunload",()=>{console.log("🛑 Client Shutting Down..."),n.shutdown()})}catch(a){console.error("❌ Failed to start Pirate MMO Client:",a);const t=document.createElement("div");t.style.cssText=`
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #ff4444; color: white; padding: 20px; border-radius: 10px;
      font-family: Arial, sans-serif; font-size: 16px; z-index: 10000;
    `,t.textContent=`Failed to start game: ${a instanceof Error?a.message:"Unknown error"}`,document.body.appendChild(t)}}function Ft(){const a=new URLSearchParams(window.location.search),t={};if(a.has("server")&&(t.network={...$.network,serverUrl:a.get("server")}),a.has("debug")&&(t.debug={...$.debug,enabled:a.get("debug")==="true"}),a.has("fps")){const e=parseInt(a.get("fps"),10);e>0&&e<=120&&(t.graphics={...$.graphics,targetFPS:e})}return t}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",K):K();K();
